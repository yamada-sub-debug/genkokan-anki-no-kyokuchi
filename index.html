<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ç¾å¤æ¼¢æš—è¨˜ã®æ¥µè‡´</title>
  <meta name="theme-color" content="#0f172a" />
  <style>
    :root {
      --bg: #0b1020;           /* æ·±ã„ç¾¤é’ã®èƒŒæ™¯ */
      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.12);
      --text: #f8fafc;         /* ã»ã¼ç™½ */
      --muted: #cbd5e1;        /* è–„ã‚ã®æ–‡å­— */
      --accent: #60a5fa;       /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆï¼ˆé’ï¼‰ */
      --accent-2: #a78bfa;     /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆï¼ˆç´«ï¼‰ */
      --shadow: 0 8px 24px rgba(0,0,0,.35);
      --radius-xl: 20px;
      --radius-lg: 14px;
      --radius-md: 10px;
      --tap: 56px;             /* è¦ªæŒ‡ã‚¿ãƒƒãƒ—ã®æœ€å°é«˜ã• */
    }

    /* âœ¨ èƒŒæ™¯ã‚’å›ºå®šã—ã¦å¢ƒç›®ã‚’ãªãã™ */
    html {
      background: var(--bg);
    }

    body {
      position: relative;
      min-height: 100dvh;
      color: var(--text);
      margin: 0;
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Hiragino Kaku Gothic ProN", "Yu Gothic", "Noto Sans JP", "Apple Color Emoji", "Segoe UI Emoji";
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      letter-spacing: .2px;
    }

    /* ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å›ºå®šã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§æç”» */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      z-index: -1;
      pointer-events: none;
      background:
        radial-gradient(1400px 800px at 80% -10%, rgba(96,165,250,.25), transparent 70%),
        radial-gradient(1200px 800px at -10% 20%, rgba(167,139,250,.25), transparent 70%),
        var(--bg);
      background-repeat: no-repeat;
      background-attachment: fixed;
    }

    /* ---- ãƒˆãƒƒãƒ—ãƒãƒ¼ ---- */
    header {
      position: sticky;
      top: 0; left: 0; right: 0;
      z-index: 30;
      backdrop-filter: saturate(1.3) blur(10px);
      -webkit-backdrop-filter: saturate(1.3) blur(10px);
      background: linear-gradient(180deg, rgba(15,23,42,.9), rgba(15,23,42,.6));
      border-bottom: 1px solid var(--stroke);
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 10px 14px;
    }

    .brand {
      display: flex; align-items: center; gap: 10px;
      padding: 8px 0 6px;
    }
    .brand .logo {
      width: 28px; height: 28px;
      display: grid; place-items: center; color: white;
      border-radius: 9px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: var(--shadow);
      font-weight: 800; font-size: 14px;
    }
    .brand h1 { font-size: 16px; margin: 0; font-weight: 700; }
    .brand .sub { font-size: 12px; color: var(--muted); }

    /* ãƒœã‚¿ãƒ³ãƒˆãƒ¬ã‚¤ */
    .tray {
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: max-content;
      gap: 10px;
      overflow-x: auto;
      padding: 8px 2px 12px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .tray::-webkit-scrollbar { display: none; }

    .pill {
      display: inline-flex; align-items: center; justify-content: center;
      height: var(--tap);
      padding: 0 18px;
      border-radius: 9999px;
      border: 1px solid var(--stroke);
      background: var(--card);
      color: var(--text);
      text-decoration: none;
      white-space: nowrap;
      font-weight: 700; font-size: 15px;
      letter-spacing: .3px;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .pill:active { transform: translateY(1px) scale(.99); }
    .pill[data-active="true"] {
      background: linear-gradient(135deg, rgba(96,165,250,.25), rgba(167,139,250,.25));
      border-color: rgba(148,163,184,.6);
    }

    /* ---- ãƒ¡ã‚¤ãƒ³ ---- */
    main {
      max-width: 900px; margin: 16px auto; padding: 0 14px 24px;
    }

    .stage {
      border: 1px dashed var(--stroke);
      border-radius: var(--radius-xl);
      background: rgba(255,255,255,.02);
      min-height: calc(100dvh - 160px);
      display: grid; place-items: center;
      padding: 24px;
    }
    .empty {
      text-align: center; color: var(--muted);
    }
    .empty h2 { font-size: 20px; margin: 0 0 8px; font-weight: 800; }
    .empty p { margin: 0; font-size: 14px; }

    /* å°ã•ã‚ç«¯æœ«ã§ä½™ç™½ã¨é«˜ã•èª¿æ•´ */
    @media (max-width: 380px) {
      .pill { height: 48px; padding: 0 14px; font-size: 14px; }
      .stage { min-height: calc(100dvh - 150px); }
    }
    /* DEV: å³ä¸‹ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç®¡ç†ãƒ‘ãƒãƒ« */
    #dev-fab { 
      position: fixed; right: 14px; bottom: 14px; z-index: 50;
      width: 56px; height: 56px; border-radius: 9999px;
      display: grid; place-items: center;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: white; font-weight: 800; border: 1px solid var(--stroke);
      box-shadow: var(--shadow); cursor: pointer; user-select: none;
    }
    #dev-panel {
      position: fixed; right: 14px; bottom: 80px; z-index: 50;
      width: min(92vw, 320px);
      border: 1px solid var(--stroke); border-radius: 14px;
      background: rgba(15,23,42,.9); backdrop-filter: blur(10px);
      padding: 12px; display: none; box-shadow: var(--shadow);
    }
    #dev-panel h4 { margin: 0 0 8px; font-size: 14px; color: var(--muted); }
    #dev-panel .row { display: grid; gap: 6px; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    #dev-panel .unit { font-size: 14px; font-weight: 800; color: var(--text); }
    #dev-panel .btns { display: flex; gap: 8px; flex-wrap: wrap; }
    #dev-panel .mini { padding: 8px 10px; height: auto; font-size: 13px; }
    #dev-panel .warn { margin-top: 6px; font-size:12px; color: #fca5a5; }

    /* åˆ‡ã‚Šå–ã‚Šå¼ã‚²ãƒ¼ã‚¸ç”¨ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
    .unit-card{
      position: relative;
      overflow: hidden;                 /* â† ã¯ã¿å‡ºã—ã‚’ç‰©ç†çš„ã«åˆ‡ã‚Šå–ã‚‹ */
      background: var(--card);          /* æœªé”éƒ¨åˆ†ã®åœ°è‰² */
      border-radius: 16px;
    }

    /* ä¸‹åœ°ï¼šãƒ•ãƒ«å¹…ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€‚å¹…ãã®ã‚‚ã®ã‚’ --pct ã«ã™ã‚‹ï¼è¦‹ãˆã¦ã‚‹å¸¯ã ã‘ */
    .unit-card::before{
      content:"";
      position:absolute;
      left:0; top:0; bottom:0;
      width: var(--pct, 0%);            /* â† é€²æ— */
      background: linear-gradient(90deg, var(--grad-start), var(--grad-mid), var(--grad-end));
      transition: width .35s ease;
      z-index:0;
    }

    /* å³ç«¯ã®ã‚µãƒ–ãƒ”ã‚¯ã‚»ãƒ«ã«ã˜ã¿å¯¾ç­–ï¼ˆ1pxãƒã‚¹ã‚¯ï¼‰ */
    .unit-card::after{
      content:"";
      position:absolute;
      top:0; right:0; bottom:0;
      width:1px;
      background: var(--card);
      pointer-events:none;
      z-index:0;
    }

    /* ä¸­èº«ã¯å¸¯ã®ä¸Šã«è¼‰ã›ã‚‹ */
    .unit-card > .uc-content{
      position: relative;
      z-index: 1;
      /* èª­ã¿ã‚„ã™ã•ã‚¢ãƒƒãƒ—ï¼ˆç™½/--mutedã®è¦–èªæ€§ï¼‰ */
      text-shadow: 0 1px 3px rgba(0,0,0,.6);
    }

    #settings-btn {
      background: none;
      border: none;
      color: var(--text);
      font-size: 20px;
      cursor: pointer;
      transition: opacity .2s ease;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    #settings-btn:hover {
      opacity: 0.8;
    }

    .logo {
      position: static;
      top: 20px;
      right: 28px;
      width: 40px;
      height: 40px;
      display: grid;
      place-items: center;
      border-radius: 10px;

      /* èƒŒæ™¯ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
      background: linear-gradient(135deg, #A855F7, #6366F1, #0EA5E9);

      /* ğŸ‚ã‚’ç™½ã§è¡¨ç¤º */
      color: #fff;
      font-size: 22px;

      /* å½±ãƒ»ç«‹ä½“æ„Ÿ */
      box-shadow: 0 2px 8px rgba(99,102,241,0.35);
      user-select: none;
    }

  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="brand">
        <div class="logo">ğŸ‚</div>
        <div style="flex:1;">
          <h1>ç¾å¤æ¼¢æš—è¨˜ã®æ¥µè‡´</h1>
        </div>
      <button id="settings-btn" aria-label="è¨­å®š"
        onclick="(()=>{const p=document.getElementById('settings-panel');if(!p)return;const cur=getComputedStyle(p).display;p.style.display=(cur==='none')?'block':'none';})();">
        ğŸ› ï¸
      </button>

      </div>

      <!-- 7ã¤ã®ãƒœã‚¿ãƒ³ï¼ˆãƒ›ãƒ¼ãƒ ï¼‹æ•™ç§‘ï¼‰ -->
      <nav class="tray" id="subjectTray" aria-label="ç§‘ç›®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³">
        <button class="pill" data-key="home" data-active="true">ãƒ›ãƒ¼ãƒ </button>
        <button class="pill" data-key="æ¼¢å­—">æ¼¢å­—</button>
        <button class="pill" data-key="ç¾ä»£æ–‡å˜èª">ç¾ä»£æ–‡å˜èª</button>
        <button class="pill" data-key="å¤å…¸æ–‡æ³•">å¤å…¸æ–‡æ³•</button>
        <button class="pill" data-key="å¤å…¸å˜èª">å¤å…¸å˜èª</button>
        <button class="pill" data-key="å¤å…¸å¸¸è­˜">å¤å…¸å¸¸è­˜</button>
        <button class="pill" data-key="æ¼¢æ–‡å¥æ³•">æ¼¢æ–‡å¥æ³•</button>
        <button class="pill" data-key="æ¼¢æ–‡èªå½™">æ¼¢æ–‡èªå½™</button>
        <button class="pill" data-key="æ¼¢æ–‡å¸¸è­˜">æ¼¢æ–‡å¸¸è­˜</button>
      </nav>
    </div>
  </header>

  <main>
    <section class="stage" id="stage">
      <div class="empty" id="empty">
      </div>
    </section>
  </main>

  <!-- â–¼ è¨­å®šãƒ‘ãƒãƒ« -->
  <div id="settings-panel" style="
    display:none;
    position:fixed;
    top:70px; right:14px;
    background:rgba(15,23,42,.95);
    border:1px solid var(--stroke);
    border-radius:12px;
    box-shadow:var(--shadow);
    padding:16px;
    z-index:100;
    min-width:220px;
    color:var(--text);
  ">
    <h4 style="margin:0 0 10px;">è¨­å®š</h4>

    <!-- JSONèª­ã¿è¾¼ã¿ -->
    <label for="jsonFile" class="pill pill--primary">DBèª­ã¿è¾¼ã¿</label>
    <input id="jsonFile" type="file" accept="application/json" style="display:none">

    <!-- DBå…¨æ¶ˆå» -->
    <button id="clearDb" class="pill pill--danger">DBå…¨æ¶ˆå»</button>

    <!-- å­¦ç¿’å±¥æ­´ãƒªã‚»ãƒƒãƒˆ -->
    <button id="reset-btn" class="pill pill--primary">å­¦ç¿’å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ</button>

  </div>


  <!-- â–¼â–¼ ã“ã“ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿JSONï¼ˆé…åˆ—ï¼‰ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã‚‹ â–¼â–¼ -->
  <script type="application/json" id="seed-data">
  </script>
  <!-- â–²â–² æœ¬ç•ªã§ã¯é…åˆ—å…¨ä½“ã«ç½®ãæ›ãˆã¦ãã ã•ã„ â–²â–² -->
    <script>
    // ---- JSONèª­ã¿è¾¼ã¿ï¼ˆHTMLå†…ã«ãã®ã¾ã¾åŒæ¢±ï¼‰ ----

    let DATA = []; 

    // ---- çŠ¶æ…‹ç®¡ç† ----
    const state = {
      subject: "home",  // 'home' | ç§‘ç›®å
      unit: null,        // å˜å…ƒåï¼ˆnull=æœªé¸æŠï¼‰
      mode: "idle",     // 'idle' | 'quiz'
      order: [],         // å‡ºé¡Œé †ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®é…åˆ—ï¼‰
      index: 0,          // ä½•å•ç›®ã‹
      showAnswer: false,
      correct: 0,
      // â–¼ è¿½åŠ ï¼šä¸æ­£è§£å¾©ç¿’ç”¨
      pool: null,      // null=é€šå¸¸ã€‚é…åˆ—=ã“ã®é…åˆ—ã ã‘å‡ºé¡Œï¼ˆãƒŸã‚¹å¾©ç¿’ãªã©ï¼‰
      wrong: [],       // ãã®å›ã§é–“é•ãˆãŸå•é¡Œã‚’ä¿æŒï¼ˆé‡è¤‡ãªã—ï¼‰
    };

    const tray = document.getElementById("subjectTray");
    const stage = document.getElementById("stage");

    tray.addEventListener("click", (e) => {
      const btn = e.target.closest(".pill");
      if (!btn) return;
      const key = btn.getAttribute("data-key");
      if (!key) return;

      tray.querySelectorAll('.pill').forEach(p => p.setAttribute('data-active', 'false'));
      btn.setAttribute('data-active', 'true');

      state.subject = key;
      state.unit = null;
      state.mode = 'idle';
      state.order = [];
      state.index = 0;
      state.showAnswer = false;
      state.correct = 0;
      render();
    });

    function getItems() {
      // â–¼ è¿½åŠ ï¼špool ãŒã‚ã‚‹ã¨ãã¯ pool ã‚’å„ªå…ˆï¼ˆã€ŒãƒŸã‚¹ã ã‘å¾©ç¿’ã€ç”¨ï¼‰
      if (Array.isArray(state.pool) && state.pool.length) return state.pool;

      let items = state.subject === 'home' ? DATA : DATA.filter(x => x.æ•™æ === state.subject);
      if (state.subject !== 'home' && state.unit) {
        items = items.filter(x => String(x.å˜å…ƒ) === String(state.unit));
      }
      return items;
    }

    function addWrong(row) {
      if (!row) return;
      if (row.id != null) {
        if (!state.wrong.some(x => x.id === row.id)) state.wrong.push(row);
      } else {
        // id ãŒç„¡ã„ã¨ãã®ç°¡æ˜“åˆ¤å®šï¼ˆfields åŒä¸€ã§åˆ¤å®šï¼‰
        const key = JSON.stringify(row.fields || {});
        if (!state.wrong.some(x => JSON.stringify(x.fields || {}) === key)) state.wrong.push(row);
      }
    }

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function startQuiz(unitKey = null) {
      if (unitKey !== null) state.unit = unitKey;

      // â–¼ è¿½åŠ ï¼šé€šå¸¸å‡ºé¡Œã«æˆ»ã—ã€ãƒŸã‚¹å±¥æ­´ã‚’ã‚¯ãƒªã‚¢
      state.pool = null;
      state.wrong = [];

      const items = getItems();
      if (!items.length) {
        stage.innerHTML = `
          <div class="empty">
            <h2>${escapeHtml(state.subject)}</h2>
            <p>ã“ã®å˜å…ƒï¼ˆã¾ãŸã¯ç§‘ç›®ï¼‰ã®ãƒ‡ãƒ¼ã‚¿ãŒ <strong>0ä»¶</strong> ã§ã™ã€‚</p>
          </div>`;
        state.mode = 'idle';
        return;
      }

      state.order = shuffle(Array.from({ length: items.length }, (_, i) => i)); // å¸¸ã«ãƒ©ãƒ³ãƒ€ãƒ 
      state.index = 0;
      state.correct = 0;
      state.showAnswer = false;
      state.mode = 'quiz';
      render();
    }

    function startQuizFromWrong() {
      if (!state.wrong.length) {
        stage.innerHTML = `
          <div class="empty">
            <h2>${escapeHtml(state.subject)} ${state.unit ? ' / ' + escapeHtml(state.unit) : ''}</h2>
            <p>ä¸æ­£è§£ã®å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            <div style="margin-top:14px;">
              <button class="pill" id="back">å˜å…ƒä¸€è¦§ã¸æˆ»ã‚‹</button>
            </div>
          </div>`;
        document.getElementById('back').addEventListener('click', () => { state.mode='idle'; render(); });
        return;
      }

      // â–¼ pool ã«ãƒŸã‚¹å•é¡Œã®ã¿ã‚’å…¥ã‚Œã¦å‡ºé¡Œã€‚æ–°ã—ã„ãƒŸã‚¹ã‚’è¨˜éŒ²ã—ç›´ã™ãŸã‚ wrong ã¯ã‚¯ãƒªã‚¢
      state.pool = state.wrong.slice();
      state.wrong = [];

      const items = getItems(); // = state.pool
      state.order = shuffle(Array.from({ length: items.length }, (_, i) => i)); // å¸¸ã«ãƒ©ãƒ³ãƒ€ãƒ 
      state.index = 0;
      state.correct = 0;
      state.showAnswer = false;
      state.mode = 'quiz';
      render();
    }

    // ===== å¾©ç¿’SRSï¼ˆlocalStorageï¼‰ =====
    const SKEY = 'gk_srs_v1';  // ã‚¹ã‚­ãƒ¼ãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³

    function lsLoad() {
      try { return JSON.parse(localStorage.getItem(SKEY) || '{}'); }
      catch { return {}; }
    }
    function lsSave(obj) { localStorage.setItem(SKEY, JSON.stringify(obj)); }

    // å˜å…ƒIDï¼ˆç§‘ç›®+å˜å…ƒï¼‰ã‚’ä¸€æ„ã«
    function unitId(subject, unit) {
      return `${subject}|||${unit ?? 'ALL'}`;
    }

    // å¾©ç¿’ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆæ—¥æ•°ï¼‰ï¼š1æ—¥å¾Œ / 7æ—¥å¾Œ / 30æ—¥å¾Œ
    const SRS_STEPS = [1, 7, 30]; // æ—¥

    // ãƒ¬ã‚³ãƒ¼ãƒ‰åˆæœŸå½¢
    function emptyRec() {
      return {
        baseDate: null,   // åˆå›å…¨å•ã‚„ã‚Šãã£ãŸæ—¥ï¼ˆYYYY-MM-DDï¼‰
        step: 0,          // 0..3ï¼ˆæ¬¡ã«ç›®æŒ‡ã™ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€‚3ã§å®Œäº†ï¼‰
        nextDue: null,    // æ¬¡ã®å¾©ç¿’äºˆå®šæ—¥ï¼ˆYYYY-MM-DDï¼‰
      };
    }

    // â–¼ ãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆUTCã‚’ä½¿ã‚ãªã„ï¼‰
    function fmtYMD(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }
    function parseLocalYMD(ymd) {
      const [y, m, d] = (ymd || '').split('-').map(Number);
      return new Date(y, (m || 1) - 1, d || 1);
    }
    function todayStr() {
      return fmtYMD(new Date());
    }
    function addDaysStr(ymd, days) {
      const d = parseLocalYMD(ymd);
      d.setDate(d.getDate() + days);
      return fmtYMD(d);
    }
    function isOnOrBeforeToday(ymd) {
      if (!ymd) return false;
      const d = parseLocalYMD(ymd).getTime();
      const t = parseLocalYMD(todayStr()).getTime();
      return d <= t;
    }

    // æœŸæ—¥è¡¨ç¤ºç”¨ï¼ˆä¸€è¦§ã®ã€Œâ—¯æ—¥å¾Œã€è¡¨ç¤ºã§åˆ©ç”¨ï¼‰
    function daysBetween(aYmd, bYmd) {
      const a = parseLocalYMD(aYmd).getTime();
      const b = parseLocalYMD(bYmd).getTime();
      return Math.round((b - a) / (1000*60*60*24));
    }
    function daysUntil(ymd) {
      if (!ymd) return null;
      return daysBetween(todayStr(), ymd);
    }
    function formatDueTag(nextDue) {
      const d = daysUntil(nextDue);
      if (d === null) return '';
      if (d < 0)   return `æœŸé™åˆ‡ã‚Œ${Math.abs(d)}æ—¥`;
      if (d === 0) return `ä»Šæ—¥`;
      return `${d}æ—¥å¾Œ`;
    }

    function currentQA() {
      const items = getItems();
      if (!items.length) return null;
      const idx = state.order[state.index] ?? 0;
      const row = items[idx];
      const fields = row?.fields || {};
      const q = String(fields.main ?? '').trim();
      const answers = Object.keys(fields)
        .filter(k => k !== 'main')
        .map(k => String(fields[k] ?? '').trim())
        .filter(Boolean);
      return { row, q, answers };
    }

    function mark(isCorrect) {
      if (isCorrect) {
        state.correct += 1;
      } else {
        const qa = currentQA();
        if (qa && qa.row) addWrong(qa.row);
      }
      next();
    }

    function next() {
      const items = getItems();

      // ã¾ã å•é¡ŒãŒæ®‹ã£ã¦ã„ã‚‹ â†’ æ¬¡ã®å•é¡Œã¸
      if (state.index + 1 < items.length) {
        state.index += 1;
        state.showAnswer = false;
        render();
        return;
      }

      // ---- ã“ã“ã‹ã‚‰çµ‚äº†å‡¦ç† ----
      const n = items.length;
      const rate = n ? Math.round((state.correct / n) * 100) : 0;
      const hasWrong = state.wrong.length > 0;

      // â–¼ SRSï¼ˆå¾©ç¿’äºˆå®šï¼‰ã®æ›´æ–°ï¼šå˜å…ƒå‡ºé¡Œã®ã¿å¯¾è±¡ï¼ˆunit ãŒ null ã®ç§‘ç›®å…¨ä½“ã¯å¯¾è±¡å¤–ï¼‰
      (function updateSRS() {
        try {
          if (!state.subject || state.unit == null) return;

          const id   = unitId(state.subject, state.unit);
          const srs  = lsLoad();
          const rec  = srs[id] || emptyRec();
          const today = todayStr();

          const wrongCount = Array.isArray(state.wrong) ? state.wrong.length : 0;
          const noWrong    = wrongCount === 0;

          // â˜…è¶…å¼·åˆ¶ã‚¬ãƒ¼ãƒ‰ï¼šä¸æ­£è§£ãŒ1å•ã§ã‚‚ã‚ã‚Œã°ä½•ã‚‚æ›´æ–°ã—ãªã„ï¼ˆåˆå›ã‚‚ä»¥å¾Œã‚‚ï¼‰
          if (!noWrong) {
            // ã‚‚ã—åˆå›ä»¥å‰ã§èª¤ã£ã¦baseDateãŒä½œã‚‰ã‚Œã¦ã„ãŸã‚‰è§¦ã‚‰ãšæ®ãˆç½®ã
            // ï¼ˆãƒªã‚»ãƒƒãƒˆã—ãŸã„é‹ç”¨ãªã‚‰ã€ã“ã“ã§ rec ã‚’åˆæœŸåŒ–ã—ã¦ã‚‚ã‚ˆã„ï¼‰
            return;
          }

          // ã“ã“ã‹ã‚‰ä¸‹ã¯ã€Œå…¨å•æ­£è§£ã€ã®ã¨ãã ã‘æ¥ã‚‹

          if (!rec.baseDate) {
            // åˆå›ï¼šå…¨å•æ­£è§£ã®ã¨ãã ã‘äºˆå®šã‚’ä½œã‚‹
            rec.baseDate = today;
            rec.step = 0; // æ¬¡ã«å‚ç…§ã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆ0=+1æ—¥ï¼‰
            rec.nextDue = addDaysStr(rec.baseDate, SRS_STEPS[0]);
          } else {
            // 2å›ç›®ä»¥é™ï¼šæœŸæ—¥ãŒä»Šæ—¥ä»¥å‰ãªã‚‰ step ã‚’1ã¤é€²ã‚ã‚‹ï¼ˆå®Œäº†ã§ nextDue=nullï¼‰
            if (isOnOrBeforeToday(rec.nextDue) && rec.step < SRS_STEPS.length) {
              rec.step += 1;
              rec.nextDue = (rec.step < SRS_STEPS.length)
                ? addDaysStr(rec.baseDate, SRS_STEPS[rec.step])
                : null;
            }
          }

          srs[id] = rec;
          lsSave(srs);
        } catch (e) {
          console.error("SRS update error:", e);
        }
      })();



      // â–¼ ä¸æ­£è§£ãƒªã‚¹ãƒˆHTML
      let wrongListHtml = "";
      if (hasWrong) {
        wrongListHtml = `
          <div style="margin-top:18px; text-align:left;">
            <h3 style="margin:0 0 8px; font-size:16px;">ä¸æ­£è§£ã®å•é¡Œ</h3>
            <div style="display:grid; gap:8px;">
              ${state.wrong.map(w => {
                const main = escapeHtml(w.fields?.main ?? "");
                const f1 = escapeHtml(w.fields?.field1 ?? "");
                const f2 = escapeHtml(w.fields?.field2 ?? "");
                return `
                  <div style="border:1px solid var(--stroke); background:rgba(255,255,255,.03); border-radius:10px; padding:10px;">
                    <div style="font-weight:700; color:var(--text); font-size:15px;">${main}</div>
                    <div style="font-size:14px; color:var(--muted); margin-top:4px;">${f1}${f1 && f2 ? "ãƒ»" : ""}${f2}</div>
                  </div>`;
              }).join("")}
            </div>
          </div>`;
      }

      // â–¼ çµæœç”»é¢
      stage.innerHTML = `
        <div class="empty" style="max-width:720px; margin:auto;">
          <h2>${escapeHtml(state.subject)}${state.unit ? ' / ' + escapeHtml(state.unit) : ''}</h2>
          <p>ã‚¹ã‚³ã‚¢ï¼š<strong>${state.correct} / ${n}</strong>ï¼ˆ${rate}%ï¼‰</p>
          ${hasWrong ? `<p style="margin-top:4px;">ä¸æ­£è§£ï¼š<strong>${state.wrong.length}</strong> ä»¶</p>` : ''}
          <div style="margin-top:14px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
            <button class="pill" id="retry">ã‚‚ã†ä¸€åº¦</button>
            ${hasWrong ? `<button class="pill" id="retryWrong">ä¸æ­£è§£ã ã‘</button>` : ''}
            <button class="pill" id="backSubject">å˜å…ƒä¸€è¦§ã¸</button>
            <button class="pill" id="backHome">ãƒ›ãƒ¼ãƒ ã¸</button>
          </div>
          ${wrongListHtml}
        </div>`;

      // â–¼ ã‚¤ãƒ™ãƒ³ãƒˆ
      document.getElementById('retry').addEventListener('click', () => startQuiz());
      if (hasWrong) {
        document.getElementById('retryWrong').addEventListener('click', startQuizFromWrong);
      }
      document.getElementById('backSubject').addEventListener('click', () => { state.mode='idle'; render(); });
      document.getElementById('backHome').addEventListener('click', () => { tray.querySelector('[data-key="home"]').click(); });

      // å®Œäº†å¾Œã¯ idle æ‰±ã„
      state.mode = 'idle';
    }

    function renderUnitList() {
      const items = state.subject === 'home' ? [] : DATA.filter(x => x.æ•™æ === state.subject);
      if (!items.length) {
        stage.innerHTML = `
          <div class="empty">
            <h2>${escapeHtml(state.subject)}</h2>
            <p>ã“ã®ç§‘ç›®ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>
          </div>`;
        return;
      }

      // å˜å…ƒã”ã¨é›†è¨ˆ
      const unitMap = new Map();
      for (const it of items) {
        const key = String(it.å˜å…ƒ);
        unitMap.set(key, (unitMap.get(key) || 0) + 1);
      }
      const units = Array.from(unitMap.entries()).sort((a,b)=> a[0].localeCompare(b[0], 'ja'));

      // â–¼ SRSã‹ã‚‰å„å˜å…ƒã®è¨˜éŒ²ã‚’å–å¾—
      const srs = lsLoad();

      // â–¼ ã“ã“ã‚’ unitCardHTML() ã«çµ±ä¸€ï¼ˆâ†ã‚²ãƒ¼ã‚¸åæ˜ ã®è‚ï¼‰
      const listHtml = units.map(([u, c]) => {
        const id = unitId(state.subject, u);
        const rec = srs[id]; // {baseDate, step, nextDue} | undefined
        return unitCardHTML(state.subject, u, c, rec, false);
      }).join('');

      stage.innerHTML = `
        <div style="width:100%; max-width:720px; display:grid; gap:12px;">
          <div style="display:flex; justify-content:space-between; align-items:end; gap:10px;">
            <div>
              <h2 style="margin:0; font-size:20px;">${escapeHtml(state.subject)}</h2>
            </div>
            <button class="pill" id="startAll">ã™ã¹ã¦ã®å˜å…ƒ</button>
          </div>
          ${listHtml}
        </div>`;

      document.getElementById('startAll').addEventListener('click', () => { state.unit = null; startQuiz(); });

      // â–¼ å˜å…ƒä¸€è¦§ã¯ data-unit-card ã‚¯ãƒªãƒƒã‚¯ã§é–‹å§‹ï¼ˆunitCardHTML å†…ã§ data-unit-card ã‚’åŸ‹ã‚ã¦ãŠãï¼‰
      stage.querySelectorAll('button[data-unit-card]').forEach(btn => {
        btn.addEventListener('click', () => startQuiz(btn.getAttribute('data-unit-card')));
      });
    }

    // æ•™ç§‘ã”ã¨ã®ãƒ©ãƒ™ãƒ«è¨­å®š
    function getLabelsForSubject(subject) {
      switch (subject) {
        case 'è‹±å˜èª': return ['æ„å‘³', 'å“è©'];  // meaning / part of speech
        case 'è‹±ç†Ÿèª': return ['æ„å‘³', 'ä¾‹'];    // idiom meaning / example
        case 'è‹±æ–‡æ³•': return ['ç”¨æ³•', 'ä¾‹'];    // usage / example
        default:       return ['è§£ç­”1', 'è§£ç­”2'];
      }
    }


    // field1 / field2 ã‚’ãƒ©ãƒ™ãƒ«ä»˜ããƒšã‚¢ã§è¿”ã™
    function getAnswerPairs(row) {
      const labels = getLabelsForSubject(state.subject);
      const a1 = String(row?.fields?.field1 ?? '').trim();
      const a2 = String(row?.fields?.field2 ?? '').trim();
      const pairs = [];
      if (a1) pairs.push([labels[0], a1]);
      if (a2) pairs.push([labels[1], a2]);
      return pairs;
    }

    function render() {
      const items = getItems();

      if (state.subject === 'home') {
        const srs = lsLoad();

        const overdue = [];
        const todayDue = [];

        Object.entries(srs).forEach(([id, rec]) => {
          if (!rec || rec.step >= 3 || !rec.nextDue) return;
          const [subject, unit] = id.split('|||');
          const delta = daysUntil(rec.nextDue); // ãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜åŸºæº–
          if (delta < 0) overdue.push({ subject, unit, rec, late: Math.abs(delta) });
          else if (delta === 0) todayDue.push({ subject, unit, rec });
        });

        const overdueHtml = overdue.length
          ? `
            <div style="margin-top:8px; text-align:left;">
              <h3 style="margin:0 0 8px; font-size:20px; color:#ffffff; font-weight:800;">æœªå®Œäº†ï¼ˆæœŸé™éãï¼‰</h3>
              <div style="display:grid; gap:8px;">
                ${overdue.map(x => unitCardHTML(x.subject, x.unit, unitCount(x.subject, x.unit), x.rec, true)).join('')}
              </div>
            </div>`
          : '';

        const todayHtml = todayDue.length
          ? `
            <div style="margin-top:16px; text-align:left;">
              <h3 style="margin:0 0 8px; font-size:20px; color:#ffffff; font-weight:800;">ä»Šæ—¥ã®å¾©ç¿’</h3>
              <div style="display:grid; gap:8px;">
                ${todayDue.map(x => unitCardHTML(x.subject, x.unit, unitCount(x.subject, x.unit), x.rec, false)).join('')}
              </div>
            </div>`
          : `<p style="margin-top:12px; font-size:13px; color:var(--muted)">æœ¬æ—¥äºˆå®šã®å¾©ç¿’ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;

        stage.innerHTML = `
          <div class="empty" id="empty" style="width:100%; max-width:720px; margin:auto; text-align:left;">
            ${overdueHtml}
            ${todayHtml}
          </div>`;

        // ã€Œå‡ºé¡Œã€ãƒœã‚¿ãƒ³ â†’ ç›´æ¥ã‚¯ã‚¤ã‚ºé–‹å§‹ï¼ˆå³å‡ºé¡Œï¼‰
        stage.querySelectorAll('[data-due-start]').forEach(btn => {
          btn.addEventListener('click', () => {
            const [subject, unit] = btn.getAttribute('data-due-start').split('|||');
            state.subject = subject;
            state.unit = unit === 'ALL' ? null : unit;
            startQuiz(state.unit); // â† å˜å…ƒç”»é¢ã‚’æŒŸã¾ãšã«ç›´æ¥é–‹å§‹
          });
        });

        return;
      }

      if (state.mode === 'idle') {
        return renderUnitList();
      }

      // mode === 'quiz'
      const qa = currentQA();
      if (!qa) return renderUnitList();
      const { q } = qa;
      const pairs = getAnswerPairs(qa.row);
      const total = items.length;
      const now = state.index + 1;

      stage.innerHTML = `
        <div style="width:100%; max-width:720px;">
          <div style="margin-bottom:6px; font-size:14px; font-weight:700; color:var(--muted); text-align:center;">
            ${escapeHtml(state.unit ?? state.subject)}
          </div>
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; font-size:13px; color:var(--muted)">
            <div>ã€€${now} / ${total}</div>
            <div>æ­£è§£ï¼š${state.correct}ã€€ä¸æ­£è§£ï¼š${state.wrong.length}</div>
          </div>

          <!-- å•é¡Œ -->
          <div style="border:1px solid var(--stroke); background:var(--card); border-radius:20px; padding:18px; box-shadow: var(--shadow);">
            <div style="font-size:14px; color:var(--muted); margin-bottom:6px;">å•é¡Œ</div>
            <div style="font-size:28px; font-weight:800; line-height:1.25;">${escapeHtml(q)}</div>
          </div>

          <!-- ç­”ãˆ -->
          <div id="answerBox" style="margin-top:14px;">
            <div style="border:1px solid var(--stroke); background:rgba(255,255,255,.03); border-radius:16px; padding:16px;">
              <div style="font-size:14px; color:var(--muted); margin-bottom:6px;">ç­”ãˆ</div>
              <div id="answerContent" style="display:grid; gap:8px; font-size:20px; font-weight:700;">
                ${pairs.map(([label, val]) => `
                  <div style="display:grid; grid-template-columns:max-content 1fr; gap:10px; align-items:start;">
                    <div style="color:var(--muted); white-space:nowrap;">${escapeHtml(label)}ï¼š</div>
                    <div>${state.showAnswer ? escapeHtml(val) : ''}</div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>

          <!-- ãƒœã‚¿ãƒ³ -->
          <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="pill" id="reveal">${state.showAnswer ? 'ç­”ãˆã‚’éš ã™' : 'ç­”ãˆã‚’è¡¨ç¤º'}</button>
            <button class="pill" id="ok">æ­£è§£</button>
            <button class="pill" id="ng">ä¸æ­£è§£</button>
          </div>
        </div>`;
      document.getElementById('reveal').addEventListener('click', () => { state.showAnswer = !state.showAnswer; render(); });
      document.getElementById('ok').addEventListener('click', () => mark(true));
      document.getElementById('ng').addEventListener('click', () => mark(false));
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }
    function escapeAttr(s) {
      return String(s).replaceAll('"', '&quot;');
    }

    // åˆæœŸè¡¨ç¤º
    render();

    // å˜å…ƒå†…ã®å•é¡Œæ•°
    function unitCount(subject, unit) {
      return DATA.filter(x => x.æ•™æ === subject && String(x.å˜å…ƒ) === String(unit)).length;
    }

    // å˜å…ƒã‚«ãƒ¼ãƒ‰HTMLï¼ˆä¸€è¦§ã¨åŒã˜è¦‹ãŸç›®ï¼‰
    function unitCardHTML(subject, unit, count, rec, emphasize = false) {
      const id = unitId(subject, unit);
      const dueTag = rec ? formatDueTag(rec.nextDue) : '';
      const progress = rec ? Math.min((rec.step + 1) / 4, 1) : 0;
      const pct = `${(Math.max(0, Math.min(1, progress)) * 100).toFixed(1)}%`;

      // ---- Cyber Neonï¼ˆè¦–èªæ€§ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°æ¸ˆã¿ï¼‰ ----
      const startColor = '#A855F7';  // ãƒã‚¤ã‚ªãƒ¬ãƒƒãƒˆï¼ˆå·¦ï¼‰
      const midColor   = '#6366F1';  // ãƒã‚ªãƒ³ãƒ‘ãƒ¼ãƒ—ãƒ«ï¼ˆä¸­ï¼‰
      const endColor   = '#0EA5E9';  // ãƒã‚ªãƒ³ãƒ–ãƒ«ãƒ¼ï¼ˆå³ï¼‰

      // æœŸæ—¥è¡Œ
      const dueLine = rec
        ? `<div style="font-size:12px; color:var(--muted);">æ¬¡ã®å¾©ç¿’ï¼š${rec.nextDue || 'â€”'}${dueTag ? `ï¼ˆ${dueTag}ï¼‰` : ''}</div>`
        : `<div style="font-size:12px; color:var(--muted);">æ¬¡ã®å¾©ç¿’ï¼šâ€”</div>`;

      return `
        <div class="unit-card"
            data-subject="${escapeAttr(subject)}"
            data-unit-card="${escapeAttr(unit)}"
            style="
              --pct:${pct};                         /* â† ã‚²ãƒ¼ã‚¸å¹…ï¼ˆåˆ‡ã‚Šå–ã‚Šï¼‰ */
              --grad-start:${startColor};           /* â† ã‚°ãƒ©ãƒ‡è‰²ï¼ˆèƒŒæ™¯ã«åˆã†ã‚µã‚¤ãƒãƒ¼ç³»ï¼‰ */
              --grad-mid:${midColor};
              --grad-end:${endColor};
              border:1px solid var(--stroke);
              ${emphasize ? 'outline:2px solid rgba(96,165,250,.35);' : ''}">
          <div class="uc-content" style="padding:14px; display:flex; justify-content:space-between; align-items:center; gap:12px;">
            <div>
              <div style="font-size:12px; color:var(--muted);">${escapeHtml(subject)}</div>
              <div style="font-size:18px; font-weight:800; color:var(--text);">${escapeHtml(unit)}</div>
              <div style="font-size:12px; color:var(--muted); margin-top:4px;">å•é¡Œæ•°ï¼š${count}</div>
              ${dueLine}
            </div>
            <!-- ãƒ›ãƒ¼ãƒ ç”¨(data-due-start) / å˜å…ƒä¸€è¦§ç”¨(data-unit-card) ä¸¡å¯¾å¿œ -->
            <button class="pill" data-judge="start"data-due-start="${escapeAttr(id)}" data-unit-card="${escapeAttr(unit)}">å‡ºé¡Œ</button>
          </div>
        </div>`;
    }

  </script>

  <!-- DEV: ä¸€æ™‚çš„ ç®¡ç†ç”¨ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ï¼†ãƒ‘ãƒãƒ« -->
  <div id="dev-fab" title="é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ï¼šä»Šæ—¥ã«è¿½åŠ ">DEV</div>
  <div id="dev-panel" role="dialog" aria-label="é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ãƒ‘ãƒãƒ«" style="display:none;">
    <h4>ä»Šæ—¥ã®å¾©ç¿’ã«è¿½åŠ ï¼ˆæ‰‹å‹•ï¼‰</h4>
    <div class="row">
      <div>ç§‘ç›® / å˜å…ƒ</div>
      <div class="unit" id="dev-target">ï¼ˆæœªé¸æŠï¼‰</div>
    </div>
    <div class="btns">
      <button class="pill mini" data-step="0">+1æ—¥ï¼ˆä»Šæ—¥ã«ï¼‰</button>
      <button class="pill mini" data-step="1">+7æ—¥ï¼ˆä»Šæ—¥ã«ï¼‰</button>
      <button class="pill mini" data-step="2">+30æ—¥ï¼ˆä»Šæ—¥ã«ï¼‰</button>
      <button class="pill mini" id="dev-close">é–‰ã˜ã‚‹</button>
    </div>
    <div class="warn" id="dev-warn" style="display:none;">â€» å˜å…ƒãŒæœªé¸æŠï¼ˆç§‘ç›®å…¨ä½“å‡ºé¡Œä¸­ï¼‰ã¯è¿½åŠ ã§ãã¾ã›ã‚“ã€‚</div>
  </div>

  <script>
  const DEV_MODE = true; // å…¬é–‹æ™‚ã¯ false ã«æˆ»ã™

  function _srsHelpersReady() {
    return typeof lsLoad === 'function'
      && typeof lsSave === 'function'
      && typeof unitId === 'function'
      && Array.isArray(SRS_STEPS)
      && typeof emptyRec === 'function'
      && typeof todayStr === 'function'
      && typeof addDaysStr === 'function';
  }

  // ä»Šæ—¥ãŒå¾©ç¿’æ—¥ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ‰‹å‹•è¿½åŠ 
  function addSRS_dueToday(subject, unit, stepIndex = 0) {
    if (!_srsHelpersReady()) { console.warn('SRSãƒ˜ãƒ«ãƒ‘ãƒ¼æœªå®šç¾©'); return; }
    if (!subject || !unit) { console.warn('subject/unit å¿…é ˆ'); return; }
    if (stepIndex < 0 || stepIndex >= SRS_STEPS.length) {
      console.warn('stepIndex ã¯ 0..' + (SRS_STEPS.length-1)); return;
    }
    const id = unitId(subject, unit);
    const srs = lsLoad();
    const rec = srs[id] || emptyRec();
    const today = todayStr();
    const offset = SRS_STEPS[stepIndex];
    const base = addDaysStr(today, -offset);

    rec.baseDate = base;
    rec.step = stepIndex; // ã“ã®æ®µéšãŒâ€œä»Šæ—¥ã®å¾©ç¿’â€
    rec.nextDue = today;

    srs[id] = rec;
    lsSave(srs);
    console.log('SRSè¿½åŠ /æ›´æ–°:', id, rec);
    if (state.subject === 'home') render(); // ãƒ›ãƒ¼ãƒ è¡¨ç¤ºä¸­ãªã‚‰å³åæ˜ 
  }

  function initDevPanel() {
    const fab = document.getElementById('dev-fab');
    const panel = document.getElementById('dev-panel');
    const target = document.getElementById('dev-target');
    const warn = document.getElementById('dev-warn');
    const closeBtn = document.getElementById('dev-close');

    if (!DEV_MODE) { fab.style.display = 'none'; panel.style.display = 'none'; return; }
    if (!fab || !panel) return;

    function updateTargetText() {
      const subj = state?.subject ?? 'ï¼ˆæœªé¸æŠï¼‰';
      const unit = (state?.unit != null) ? state.unit : 'ï¼ˆç§‘ç›®å…¨ä½“ï¼‰';
      target.textContent = `${subj} / ${unit}`;
      warn.style.display = (state?.unit == null) ? '' : 'none';
    }

    fab.addEventListener('click', () => {
      updateTargetText();
      panel.style.display = (panel.style.display === 'none' || !panel.style.display) ? 'block' : 'none';
    });

    closeBtn.addEventListener('click', () => { panel.style.display = 'none'; });

    panel.querySelectorAll('[data-step]').forEach(btn => {
      btn.addEventListener('click', () => {
        if (state?.unit == null) { updateTargetText(); return; } // å˜å…ƒæœªé¸æŠã¯æ‹’å¦
        const step = parseInt(btn.getAttribute('data-step') || '0', 10);
        addSRS_dueToday(state.subject, state.unit, step);
        panel.style.display = 'none';
      });
    });
  }

  // â˜… DOMæ§‹ç¯‰å¾Œã«åˆæœŸåŒ–ï¼ˆã“ã“é‡è¦ï¼‰
  document.addEventListener('DOMContentLoaded', initDevPanel);
  </script>

  <script>
    const settingsBtn = document.getElementById('settings-btn');
    const settingsPanel = document.getElementById('settings-panel');
    const resetBtn = document.getElementById('reset-btn');

    // è¨­å®šãƒ‘ãƒãƒ«é–‹é–‰
    settingsBtn.addEventListener('click', () => {
      const show = settingsPanel.style.display === 'none';
      settingsPanel.style.display = show ? 'block' : 'none';
    });

    // å¾©ç¿’å±¥æ­´ãƒªã‚»ãƒƒãƒˆ
    resetBtn.addEventListener('click', () => {
      if (confirm('æœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
        localStorage.clear();
        alert('é€²æ—ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
        location.reload();
      }
    });
  </script>

  <script>
  // ===== IndexedDBï¼ˆcardsã‚¹ãƒˆã‚¢ï¼‰ =====
  const DB_NAME = 'gk_cards';
  const DB_VERSION = 1;
  const STORE = 'cards';

  function openDb() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, DB_VERSION);
      req.onupgradeneeded = (e) => {
        const db = req.result;
        if (!db.objectStoreNames.contains(STORE)) {
          const os = db.createObjectStore(STORE, { keyPath: 'id' });
          os.createIndex('by_subject', 'æ•™æ', { unique: false });
          os.createIndex('by_unit', 'å˜å…ƒ', { unique: false });
          os.createIndex('by_subject_unit', ['æ•™æ', 'å˜å…ƒ'], { unique: false });
        }
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }

  function withStore(db, mode, fn) {
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE, mode);
      const st = tx.objectStore(STORE);
      const r = fn(st);
      tx.oncomplete = () => resolve(r);
      tx.onerror = () => reject(tx.error);
    });
  }

  async function idbGetAll() {
    const db = await openDb();
    return new Promise((resolve, reject) => {
      withStore(db, 'readonly', (st) => {
        const req = st.getAll();
        req.onsuccess = () => resolve(req.result || []);
        req.onerror = () => reject(req.error);
      });
    });
  }

  async function idbBulkPut(rows) {
    const db = await openDb();
    await withStore(db, 'readwrite', (st) => {
      rows.forEach(row => st.put(row));
    });
  }

  async function idbClear() {
    const db = await openDb();
    await withStore(db, 'readwrite', (st) => st.clear());
  }

  // ===== èµ·å‹•æ™‚ï¼šDB -> DATA ã¸ãƒ­ãƒ¼ãƒ‰ï¼ˆDBãŒç©ºãªã‚‰ seed-data ã‚’æµã—è¾¼ã‚€ï¼‰ =====
  async function bootDataFromIDB() {
    // 1) DBã‹ã‚‰èª­ã¿è¾¼ã‚€
    let rows = await idbGetAll();

    // 2) ç©ºãªã‚‰ <script id="seed-data"> ã®é…åˆ—ã§åˆæœŸåŒ–
    if (!rows || rows.length === 0) {
      const seedTag = document.getElementById('seed-data');
      if (seedTag?.textContent?.trim()) {
        try {
          const seed = JSON.parse(seedTag.textContent);
          if (Array.isArray(seed) && seed.length) {
            await idbBulkPut(seed);
            rows = await idbGetAll();
            console.log('Seeded DB from <script id="seed-data">');
          }
        } catch (e) {
          console.warn('Seed parse failed:', e);
        }
      }
    }

    // 3) ã‚°ãƒ­ãƒ¼ãƒãƒ« DATA ã‚’å·®ã—æ›¿ãˆï¼ˆæ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯äº’æ›ï¼‰
    DATA = rows;
    console.log('DATA loaded from IDB:', rows.length);
  }

  // ===== è¨­å®šãƒ‘ãƒãƒ«ã®UIï¼ˆé–‹é–‰ã¯æ—¢å­˜ã® settings-btn ã‚’æƒ³å®šï¼‰ =====
  document.getElementById('settings-btn')?.addEventListener('click', () => {
    const p = document.getElementById('settings-panel');
    if (!p) return;
    p.style.display = (p.style.display === 'block') ? 'none' : 'block';
  });

  // ===== ãƒ•ã‚¡ã‚¤ãƒ«å–è¾¼ï¼ˆJSON -> DBã«ä¿å­˜ -> DATAæ›´æ–°ï¼‰ =====
  document.getElementById('jsonFile')?.addEventListener('change', async (ev) => {
    const file = ev.target.files?.[0];
    if (!file) return;
    try {
      const text = await file.text();
      const arr = JSON.parse(text);
      if (!Array.isArray(arr)) throw new Error('JSONã¯é…åˆ—ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
      await idbBulkPut(arr);
      const all = await idbGetAll();
      DATA = all;                       // â† window.DATA ã˜ã‚ƒãªã DATA ã«ä»£å…¥
      alert(`å–ã‚Šè¾¼ã¿å®Œäº†ï¼š${arr.length}ä»¶ï¼ˆDBåˆè¨ˆï¼š${all.length}ä»¶ï¼‰`);
      render();                         // â˜… ã“ã‚Œã‚’å¿…ãšå‘¼ã¶
    } catch (e) {
      alert('å–ã‚Šè¾¼ã¿å¤±æ•—ï¼š' + e.message);
    } finally {
      ev.target.value = '';
    }
  });

  // ===== JSONæ›¸ãå‡ºã— =====
  document.getElementById('exportJson')?.addEventListener('click', async () => {
    const all = await idbGetAll();
    const blob = new Blob([JSON.stringify(all, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'cards-export.json';
    a.click();
    URL.revokeObjectURL(url);
  });

  // ===== DBå…¨æ¶ˆå»ï¼ˆã‚«ãƒ¼ãƒ‰ã®ã¿ã€‚SRSã¯åˆ¥ï¼‰ =====
  document.getElementById('clearDb')?.addEventListener('click', async () => {
    if (!confirm('ã‚«ãƒ¼ãƒ‰DBã‚’å…¨æ¶ˆå»ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
    await idbClear();
    window.DATA = [];
    alert('DBã‚’ç©ºã«ã—ã¾ã—ãŸã€‚');
  });

  // ===== èµ·å‹•ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ï¼šDBèª­ã¿è¾¼ã¿å¾Œã«æœ€åˆã®æç”»ã¸ =====
  (async () => {
    try {
      await bootDataFromIDB();
      render();               // â˜… ã“ã“ã§åˆå›æç”»
    } catch(e) { console.error('[boot] failed:', e); }
  })();
  </script>

</body>
</html>
