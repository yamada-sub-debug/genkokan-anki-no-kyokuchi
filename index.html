<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ç¾å¤æ¼¢æš—è¨˜ã®æ¥µè‡´</title>
  <meta name="theme-color" content="#0f172a" />
  <style>
    :root {
      --bg: #0b1020;
      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.12);
      --text: #f8fafc;
      --muted: #cbd5e1;
      --accent: #60a5fa;
      --accent-2: #a78bfa;
      --shadow: 0 8px 24px rgba(0,0,0,.35);
      --radius-xl: 20px;
      --radius-lg: 14px;
      --radius-md: 10px;
      --tap: 56px;
    }

    html {
      background: var(--bg);
    }

    body {
      position: relative;
      min-height: 100dvh;
      color: var(--text);
      margin: 0;
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Hiragino Kaku Gothic ProN", "Yu Gothic", "Noto Sans JP", "Apple Color Emoji", "Segoe UI Emoji";
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      letter-spacing: .2px;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      z-index: -1;
      pointer-events: none;
      background-color: var(--bg);
      background-repeat: no-repeat;
      background-attachment: absolute;
    }

    header {
      position: sticky;
      top: 0; left: 0; right: 0;
      z-index: 30;
      backdrop-filter: saturate(1.3) blur(10px);
      -webkit-backdrop-filter: saturate(1.3) blur(10px);
      background: linear-gradient(180deg, rgba(15,23,42,.9), rgba(15,23,42,.6));
      border-bottom: 1px solid var(--stroke);
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 10px 14px;
    }

    .brand {
      display: flex; align-items: center; gap: 10px;
      padding: 8px 0 6px;
    }
    .brand .logo {
      width: 28px; height: 28px;
      display: grid; place-items: center; color: white;
      border-radius: 9px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: var(--shadow);
      font-weight: 800; font-size: 14px;
    }
    .brand h1 { font-size: 16px; margin: 0; font-weight: 700; }
    .brand .sub { font-size: 12px; color: var(--muted); }

    .tray {
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: max-content;
      gap: 10px;
      overflow-x: auto;
      padding: 8px 2px 12px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .tray::-webkit-scrollbar { display: none; }

    .pill {
      display: inline-flex; align-items: center; justify-content: center;
      height: var(--tap);
      padding: 0 18px;
      border-radius: 9999px;
      border: 1px solid var(--stroke);
      background: var(--card);
      color: var(--text);
      text-decoration: none;
      white-space: nowrap;
      font-weight: 700; font-size: 15px;
      letter-spacing: .3px;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .pill:active { transform: translateY(1px) scale(.99); }
    .pill[data-active="true"] {
      background: linear-gradient(135deg, rgba(96,165,250,.25), rgba(167,139,250,.25));
      border-color: rgba(148,163,184,.6);
    }

    main {
      max-width: 900px; margin: 16px auto; padding: 0 14px 24px;
    }

    .stage {
      border: 1px solid var(--stroke);
      border-radius: var(--radius-xl);
      background: rgba(255,255,255,.02);
      min-height: calc(100dvh - 160px);
      display: grid; place-items: center;
      padding: 24px;
    }
    .empty {
      text-align: center; color: var(--muted);
    }
    .empty h2 { font-size: 20px; margin: 0 0 8px; font-weight: 800; }
    .empty p { margin: 0; font-size: 14px; }

    @media (max-width: 380px) {
      .pill { height: 48px; padding: 0 14px; font-size: 14px; }
      .stage { min-height: calc(100dvh - 150px); }
    }
    #dev-fab { 
      position: fixed; right: 14px; bottom: 14px; z-index: 50;
      width: 56px; height: 56px; border-radius: 9999px;
      display: grid; place-items: center;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: white; font-weight: 800; border: 1px solid var(--stroke);
      box-shadow: var(--shadow); cursor: pointer; user-select: none;
    }
    #dev-panel {
      position: fixed; right: 14px; bottom: 80px; z-index: 50;
      width: min(92vw, 320px);
      border: 1px solid var(--stroke); border-radius: 14px;
      background: rgba(15,23,42,.9); backdrop-filter: blur(10px);
      padding: 12px; display: none; box-shadow: var(--shadow);
    }
    #dev-panel h4 { margin: 0 0 8px; font-size: 14px; color: var(--muted); }
    #dev-panel .row { display: grid; gap: 6px; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    #dev-panel .unit { font-size: 14px; font-weight: 800; color: var(--text); }
    #dev-panel .btns { display: flex; gap: 8px; flex-wrap: wrap; }
    #dev-panel .mini { padding: 8px 10px; height: auto; font-size: 13px; }
    #dev-panel .warn { margin-top: 6px; font-size:12px; color: #fca5a5; }

    .unit-card{
      position: relative;
      overflow: hidden;
      background: var(--card);
      border-radius: 16px;
    }

    .unit-card::before{
      content:"";
      position:absolute;
      left:0; top:0; bottom:0;
      width: var(--pct, 0%);
      background: linear-gradient(90deg, var(--grad-start), var(--grad-mid), var(--grad-end));
      transition: width .35s ease;
      z-index:0;
    }

    .unit-card::after{
      content:"";
      position:absolute;
      top:0; right:0; bottom:0;
      width:1px;
      background: var(--card);
      pointer-events:none;
      z-index:0;
    }

    .unit-card > .uc-content{
      position: relative;
      z-index: 1;
      text-shadow: 0 1px 3px rgba(0,0,0,.6);
    }

    #settings-btn {
      background: none;
      border: none;
      color: var(--text);
      font-size: 20px;
      cursor: pointer;
      transition: opacity .2s ease;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    #settings-btn:hover {
      opacity: 0.8;
    }

    #addUnit {
      display: none;
    }
    
    @media (min-width: 768px) {
      #addUnit {
        display: inline-flex;
      }
    }

    .site-link {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: inherit;
    }

    .site-link:hover {
      opacity: .85;
    }

  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="brand">
        <a
          class="site-link"
          href="https://yamada-sub-debug.github.io/eigo-anki-no-shinzui/"
        >
          <div class="logo">ğŸ‚</div>
          <h1>ç¾å¤æ¼¢æš—è¨˜ã®æ¥µè‡´</h1>
        </a>

        <div style="flex:1;"></div>
        <button id="settings-btn" aria-label="è¨­å®š">ğŸ› ï¸</button>
      </div>

      <nav class="tray" id="subjectTray" aria-label="ç§‘ç›®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³">
        <button class="pill" data-key="home" data-active="true">ğŸ </button>
        <button class="pill" data-key="æ¼¢å­—">æ¼¢å­—</button>
        <button class="pill" data-key="ç¾ä»£æ–‡å˜èª">ç¾ä»£æ–‡å˜èª</button>
        <button class="pill" data-key="å¤å…¸æ–‡æ³•">å¤å…¸æ–‡æ³•</button>
        <button class="pill" data-key="å¤å…¸å˜èª">å¤å…¸å˜èª</button>
        <button class="pill" data-key="å¤å…¸å¸¸è­˜">å¤å…¸å¸¸è­˜</button>
        <button class="pill" data-key="æ¼¢æ–‡å¥æ³•">æ¼¢æ–‡å¥æ³•</button>
        <button class="pill" data-key="æ¼¢æ–‡èªå½™">æ¼¢æ–‡èªå½™</button>
        <button class="pill" data-key="æ¼¢æ–‡å¸¸è­˜">æ¼¢æ–‡å¸¸è­˜</button>
      </nav>
    </div>
  </header>

  <main>
    <section class="stage" id="stage">
      <div class="empty" id="empty">
      </div>
    </section>
  </main>

  <div id="settings-panel" style="
    display:none;
    position:fixed;
    top:70px; right:14px;
    background:rgba(15,23,42,.95);
    border:1px solid var(--stroke);
    border-radius:12px;
    box-shadow:var(--shadow);
    padding:16px;
    z-index:100;
    min-width:220px;
    color:var(--text);
  ">
    <h4 style="margin:0 0 10px;">è¨­å®š</h4>

    <label for="jsonFile" class="pill pill--primary">DBèª­ã¿è¾¼ã¿</label>
    <input id="jsonFile" type="file" accept="application/json" multiple style="display:none">

    <button id="clearDb" class="pill pill--danger">DBå…¨æ¶ˆå»</button>

    <button id="reset-btn" class="pill pill--primary">å­¦ç¿’å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ</button>

  </div>

    <script>

    let DATA = []; 
    let unitCreatorRows = null;

    const APP_NS = 'kokugo';

    const state = {
      subject: "home",
      unit: null,
      mode: "idle",
      order: [],
      index: 0,
      showAnswer: false,
      correct: 0,
      pool: null,
      wrong: [],
      view: "main",
    };

    const tray = document.getElementById("subjectTray");
    const stage = document.getElementById("stage");

    tray.addEventListener("click", (e) => {
      const btn = e.target.closest(".pill");
      if (!btn) return;
      const key = btn.getAttribute("data-key");
      if (!key) return;

      tray.querySelectorAll('.pill').forEach(p => p.setAttribute('data-active', 'false'));
      btn.setAttribute('data-active', 'true');

      state.view = 'main';
      const legacy = document.getElementById('settings-panel');
      if (legacy) legacy.style.display = 'none';

      state.subject = key;
      state.unit = null;
      state.mode = 'idle';
      state.order = [];
      state.index = 0;
      state.showAnswer = false;
      state.correct = 0;
      render();
    });

    function getItems() {
      if (Array.isArray(state.pool) && state.pool.length) return state.pool;

      let items = state.subject === 'home' ? DATA : DATA.filter(x => x.æ•™æ === state.subject);
      if (state.subject !== 'home' && state.unit) {
        items = items.filter(x => String(x.å˜å…ƒ) === String(state.unit));
      }
      return items;
    }

    function addWrong(row) {
      if (!row) return;
      if (row.id != null) {
        if (!state.wrong.some(x => x.id === row.id)) state.wrong.push(row);
      } else {
        const key = JSON.stringify(row.fields || {});
        if (!state.wrong.some(x => JSON.stringify(x.fields || {}) === key)) state.wrong.push(row);
      }
    }

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function naturalCompare(a, b) {
      const ax = [];
      const bx = [];

      a.replace(/(\d+)|(\D+)/g, (_, $1, $2) => {
        ax.push([$1 || "", $2 || ""]);
      });
      b.replace(/(\d+)|(\D+)/g, (_, $1, $2) => {
        bx.push([$1 || "", $2 || ""]);
      });

      while (ax.length && bx.length) {
        const an = ax.shift();
        const bn = bx.shift();

        const numA = parseInt(an[0], 10);
        const numB = parseInt(bn[0], 10);
        const aIsNum = !isNaN(numA);
        const bIsNum = !isNaN(numB);

        if (aIsNum && bIsNum) {
          if (numA !== numB) return numA - numB;
        } else {
          const c = an[1].localeCompare(bn[1], 'ja');
          if (c !== 0) return c;
        }
      }

      return ax.length - bx.length;
    }

    function startQuiz(unitKey = null) {
      if (unitKey !== null) state.unit = unitKey;

      state.pool = null;
      state.wrong = [];

      const items = getItems();
      if (!items.length) {
        stage.innerHTML = `
          <div class="empty">
            <h2>${escapeHtml(state.subject)}</h2>
            <p>ã“ã®å˜å…ƒï¼ˆã¾ãŸã¯ç§‘ç›®ï¼‰ã®ãƒ‡ãƒ¼ã‚¿ãŒ <strong>0ä»¶</strong> ã§ã™ã€‚</p>
          </div>`;
        state.mode = 'idle';
        return;
      }

      state.order = shuffle(Array.from({ length: items.length }, (_, i) => i));
      state.index = 0;
      state.correct = 0;
      state.showAnswer = false;
      state.mode = 'quiz';
      render();
    }

    function startQuizFromWrong() {
      if (!state.wrong.length) {
        stage.innerHTML = `
          <div class="empty">
            <h2>${escapeHtml(state.subject)} ${state.unit ? ' / ' + escapeHtml(state.unit) : ''}</h2>
            <p>ä¸æ­£è§£ã®å•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            <div style="margin-top:14px;">
              <button class="pill" id="back">å˜å…ƒä¸€è¦§ã¸æˆ»ã‚‹</button>
            </div>
          </div>`;
        document.getElementById('back').addEventListener('click', () => { state.mode='idle'; render(); });
        return;
      }

      state.pool = state.wrong.slice();
      state.wrong = [];

      const items = getItems();
      state.order = shuffle(Array.from({ length: items.length }, (_, i) => i));
      state.index = 0;
      state.correct = 0;
      state.showAnswer = false;
      state.mode = 'quiz';
      render();
    }

    const SKEY = `${APP_NS}_srs_v1`;

    function lsLoad() {
      try { return JSON.parse(localStorage.getItem(SKEY) || '{}'); }
      catch { return {}; }
    }
    function lsSave(obj) { localStorage.setItem(SKEY, JSON.stringify(obj)); }

    function unitId(subject, unit) {
      return `${subject}|||${unit ?? 'ALL'}`;
    }

    const SRS_STEPS = [1, 7, 30];

    function emptyRec() {
      return {
        baseDate: null,
        step: 0,
        nextDue: null,
      };
    }

    function fmtYMD(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }
    function parseLocalYMD(ymd) {
      const [y, m, d] = (ymd || '').split('-').map(Number);
      return new Date(y, (m || 1) - 1, d || 1);
    }
    function todayStr() {
      const d = new Date();
      if (d.getHours() < 5) d.setDate(d.getDate() - 1);
      return fmtYMD(d);
    }
    function addDaysStr(ymd, days) {
      const d = parseLocalYMD(ymd);
      d.setDate(d.getDate() + days);
      return fmtYMD(d);
    }
    function isOnOrBeforeToday(ymd) {
      if (!ymd) return false;
      const d = parseLocalYMD(ymd).getTime();
      const t = parseLocalYMD(todayStr()).getTime();
      return d <= t;
    }

    function daysBetween(aYmd, bYmd) {
      const a = parseLocalYMD(aYmd).getTime();
      const b = parseLocalYMD(bYmd).getTime();
      return Math.round((b - a) / (1000*60*60*24));
    }
    function daysUntil(ymd) {
      if (!ymd) return null;
      return daysBetween(todayStr(), ymd);
    }
    function formatDueTag(nextDue) {
      const d = daysUntil(nextDue);
      if (d === null) return '';
      if (d < 0)   return `äºˆå®šæ—¥+${Math.abs(d)}æ—¥`;
      if (d === 0) return `ä»Šæ—¥`;
      return `${d}æ—¥å¾Œ`;
    }

    function currentQA() {
      const items = getItems();
      if (!items.length) return null;
      const idx = state.order[state.index] ?? 0;
      const row = items[idx];
      const fields = row?.fields || {};
      const q = String(fields.main ?? '').trim();
      const answers = Object.keys(fields)
        .filter(k => k !== 'main')
        .map(k => String(fields[k] ?? '').trim())
        .filter(Boolean);
      return { row, q, answers };
    }

    function mark(isCorrect) {
      if (isCorrect) {
        state.correct += 1;
      } else {
        const qa = currentQA();
        if (qa && qa.row) addWrong(qa.row);
      }
      next();
    }

    function next() {
      const items = getItems();

      if (state.index + 1 < items.length) {
        state.index += 1;
        state.showAnswer = false;
        render();
        return;
      }

      const n = items.length;
      const rate = n ? Math.round((state.correct / n) * 100) : 0;
      const hasWrong = state.wrong.length > 0;

      (function updateSRS() {
        try {
          if (!state.subject || state.unit == null) return;

          const id   = unitId(state.subject, state.unit);
          const srs  = lsLoad();
          const rec  = srs[id] || emptyRec();
          const today = todayStr();

          const wrongCount = Array.isArray(state.wrong) ? state.wrong.length : 0;
          const noWrong    = wrongCount === 0;

          if (!noWrong) {
            return;
          }

          if (!rec.baseDate) {
            rec.baseDate = today;
            rec.step = 0;
            rec.nextDue = addDaysStr(rec.baseDate, SRS_STEPS[0]);
          } else {
            if (isOnOrBeforeToday(rec.nextDue) && rec.step < SRS_STEPS.length) {
              rec.step += 1;
              rec.nextDue = (rec.step < SRS_STEPS.length)
                ? addDaysStr(rec.baseDate, SRS_STEPS[rec.step])
                : null;
            }
          }

          srs[id] = rec;
          lsSave(srs);
        } catch (e) {
          console.error("SRS update error:", e);
        }
      })();

      let wrongListHtml = "";
      if (hasWrong) {
        wrongListHtml = `
          <div style="margin-top:18px; text-align:left;">
            <h3 style="margin:0 0 8px; font-size:16px;">ä¸æ­£è§£ã®å•é¡Œ</h3>
            <div style="display:grid; gap:8px;">
              ${state.wrong.map(w => {
                const main = escapeHtml(w.fields?.main ?? "");
                const f1 = escapeHtml(w.fields?.field1 ?? "");
                const f2 = escapeHtml(w.fields?.field2 ?? "");
                return `
                  <div style="border:1px solid var(--stroke); background:rgba(255,255,255,.03); border-radius:10px; padding:10px;">
                    <div style="font-weight:700; color:var(--text); font-size:15px;">${main}</div>
                    <div style="font-size:14px; color:var(--muted); margin-top:4px;">${f1}${f1 && f2 ? "ãƒ»" : ""}${f2}</div>
                  </div>`;
              }).join("")}
            </div>
          </div>`;
      }

      stage.innerHTML = `
        <div class="empty" style="max-width:720px; margin:auto;">
          <h2>${escapeHtml(state.subject)}${state.unit ? ' / ' + escapeHtml(state.unit) : ''}</h2>
          <p>ã‚¹ã‚³ã‚¢ï¼š<strong>${state.correct} / ${n}</strong>ï¼ˆ${rate}%ï¼‰</p>
          ${hasWrong ? `<p style="margin-top:4px;">ä¸æ­£è§£ï¼š<strong>${state.wrong.length}</strong> å•</p>` : ''}
          <div style="margin-top:14px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
            <button class="pill" id="retry">ã‚‚ã†ä¸€åº¦</button>
            ${hasWrong ? `<button class="pill" id="retryWrong">ä¸æ­£è§£ã ã‘</button>` : ''}
            <button class="pill" id="backSubject">å˜å…ƒä¸€è¦§ã¸</button>
            <button class="pill" id="backHome">ãƒ›ãƒ¼ãƒ ã¸</button>
          </div>
          ${wrongListHtml}
        </div>`;

      document.getElementById('retry').addEventListener('click', () => startQuiz());
      if (hasWrong) {
        document.getElementById('retryWrong').addEventListener('click', startQuizFromWrong);
      }
      document.getElementById('backSubject').addEventListener('click', () => { state.mode='idle'; render(); });
      document.getElementById('backHome').addEventListener('click', () => { tray.querySelector('[data-key="home"]').click(); });

      state.mode = 'idle';
    }

    function renderUnitList() {
      const subject = state.subject;

      const items = subject === 'home'
        ? []
        : DATA.filter(x => x.æ•™æ === subject);

      const unitMap = new Map();
      for (const it of items) {
        const key = String(it.å˜å…ƒ);
        unitMap.set(key, (unitMap.get(key) || 0) + 1);
      }

      const units = Array.from(unitMap.entries())
        .sort((a, b) => naturalCompare(a[0], b[0]));

      const hasUnits = units.length > 0;
      const srs = lsLoad();

      const listHtml = hasUnits
        ? units.map(([u, c]) => {
            const id  = unitId(subject, u);
            const rec = srs[id];
            return unitCardHTML(subject, u, c, rec, false, true);
          }).join('')
        : `
          <div class="empty" style="padding:16px 0;">
            <h2>${escapeHtml(subject)}</h2>
            <p>ã“ã®ç§‘ç›®ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>
          </div>
        `;

      stage.innerHTML = `
        <div style="width:100%; max-width:720px; display:grid; gap:12px;">
          <div style="display:flex; justify-content:space-between; align-items:end; gap:10px;">
            <div>
              <h2 style="margin:0; font-size:20px;">${escapeHtml(subject)}</h2>
            </div>
            <div style="display:flex; gap:8px;">
              <button class="pill" id="addUnit">ï¼‹</button>
            </div>
          </div>
          ${listHtml}
        </div>
      `;

      document.getElementById('addUnit').addEventListener('click', () => {
        renderUnitCreator(subject);
      });

      if (hasUnits) {
        stage.querySelectorAll('button[data-due-start]').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-due-start');
            const [subj, unit] = id.split('|||');

            state.subject = subj;
            state.unit = unit === 'ALL' ? null : unit;
            state.mode = 'idle';
            startQuiz(state.unit);
          });
        });

        stage.querySelectorAll('button[data-unit-list]').forEach(btn => {
          btn.addEventListener('click', () => {
            const unit = btn.getAttribute('data-unit-list');
            renderProblemList(subject, unit);
          });
        });
      }
    }

    function renderUnitCreator(subject) {
    const baseSubject = String(subject);

    if (!Array.isArray(unitCreatorRows) || unitCreatorRows.length === 0) {
        unitCreatorRows = Array.from({ length: 30 }, () => ({ main: '', f1: '', f2: '' }));
    }

    function syncFromDom() {
        const rows = unitCreatorRows;
        rows.forEach((row, i) => {
        const mainEl = document.getElementById(`q-main-${i}`);
        const f1El   = document.getElementById(`q-f1-${i}`);
        const f2El   = document.getElementById(`q-f2-${i}`);
        if (!mainEl || !f1El || !f2El) return;
        row.main = mainEl.value;
        row.f1   = f1El.value;
        row.f2   = f2El.value;
        });
    }

    function draw() {
        const rowsHtml = unitCreatorRows.map((row, i) => {
        const n = i + 1;
        return `
            <div style="
            display:grid;
            grid-template-columns: max-content 1fr 1fr 1fr max-content max-content;
            gap:6px 8px;
            align-items:center;
            ">
            <div style="font-size:12px; color:var(--muted);">No.${n}</div>
            <input
                type="text"
                placeholder=""
                id="q-main-${i}"
                value="${escapeAttr(row.main)}"
                style="padding:8px 10px; border-radius:8px; border:1px solid var(--stroke);
                    background:rgba(15,23,42,.9); color:var(--text); font-size:13px;">
            <input
                type="text"
                placeholder=""
                id="q-f1-${i}"
                value="${escapeAttr(row.f1)}"
                style="padding:8px 10px; border-radius:8px; border:1px solid var(--stroke);
                    background:rgba(15,23,42,.9); color:var(--text); font-size:13px;">
            <input
                type="text"
                placeholder=""
                id="q-f2-${i}"
                value="${escapeAttr(row.f2)}"
                style="padding:8px 10px; border-radius:8px; border:1px solid var(--stroke);
                    background:rgba(15,23,42,.9); color:var(--text); font-size:13px;">
            <button
                type="button"
                class="pill"
                data-delete-row="${i}"
                style="
                padding:0 10px;
                height:32px;
                font-size:14px;
                min-width:auto;
                border-color:#f87171;
                color:#fecaca;
                ">
                âœ•
            </button>
            <button
              type="button"
              class="pill"
              data-insert-after="${i}"
              style="
                padding:0 8px;
                height:32px;
                font-size:12px;
                min-width:auto;
              ">
              â†™
            </button>
            </div>
          `;
        }).join('');

        stage.innerHTML = `
        <div style="width:100%; max-width:720px; margin:auto; display:grid; gap:14px;">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <h2 style="margin:0; font-size:20px;">å˜å…ƒè¿½åŠ ï¼ˆ${escapeHtml(subject)}ï¼‰</h2>
            <button class="pill" id="backUnits">â†¶</button>
            </div>

            <div style="border:1px solid var(--stroke); background:var(--card);
                        border-radius:16px; padding:14px; display:grid; gap:10px;">
            <div style="font-size:12px; color:var(--muted);">
                ç§‘ç›®ï¼š${escapeHtml(baseSubject)}
            </div>
            <label style="display:grid; gap:4px; font-size:13px;">
                <span style="color:var(--muted);">å˜å…ƒå</span>
                <input id="newUnitName" type="text"
                placeholder=""
                style="padding:8px 10px; border-radius:8px; border:1px solid var(--stroke);
                        background:rgba(15,23,42,.9); color:var(--text); font-size:14px;">
            </label>
            </div>

            <div style="border:1px solid var(--stroke); background:var(--card);
                        border-radius:16px; padding:14px; display:grid; gap:10px;">
            <div style="font-size:14px; color:var(--muted); margin-bottom:4px;">
                å•é¡Œå…¥åŠ›ï¼ˆå•é¡Œï½œç­”ãˆ1ï½œç­”ãˆ2ï¼‰<br>
            </div>
            <div style="display:grid; gap:8px;">
                ${rowsHtml}
            </div>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="pill" id="add30Rows">+30å•</button>
            <button class="pill" id="saveUnit">å˜å…ƒè¿½åŠ </button>
            </div>
        </div>
        `;

        document.getElementById('backUnits').addEventListener('click', () => {
        unitCreatorRows = null;
        renderUnitList();
        });

        document.getElementById('add30Rows').addEventListener('click', () => {
        syncFromDom();
        for (let i = 0; i < 30; i++) {
            unitCreatorRows.push({ main: '', f1: '', f2: '' });
        }
        draw();
        });

        stage.querySelectorAll('button[data-delete-row]').forEach(btn => {
        btn.addEventListener('click', () => {
            const idx = Number(btn.getAttribute('data-delete-row')) || 0;
            syncFromDom();
            unitCreatorRows.splice(idx, 1);
            draw();
        });
        });

        stage.querySelectorAll('button[data-insert-after]').forEach(btn => {
        btn.addEventListener('click', () => {
            const idx = Number(btn.getAttribute('data-insert-after')) || 0;
            syncFromDom();
            unitCreatorRows.splice(idx + 1, 0, { main: '', f1: '', f2: '' });
            draw();
        });
        });

        document.getElementById('saveUnit').addEventListener('click', async () => {
        syncFromDom();

        const unitName = document.getElementById('newUnitName').value.trim();
        if (!unitName) {
            alert('å˜å…ƒåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        const newRows = [];
        for (const row of unitCreatorRows) {
            const main = String(row.main || '').trim();
            const f1   = String(row.f1   || '').trim();
            const f2   = String(row.f2   || '').trim();
            if (!main && !f1 && !f2) continue;

            newRows.push({
            id: null,
            æ•™æ: baseSubject,
            å˜å…ƒ: unitName,
            fields: {
                main,
                field1: f1,
                field2: f2,
            }
            });
        }

        if (!newRows.length) {
            alert('1å•ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        const maxId = DATA.length
            ? Math.max(...DATA.map(r => Number(r.id) || 0))
            : 0;
        newRows.forEach((row, idx) => {
            row.id = maxId + idx + 1;
        });

        try {
            await idbBulkPut(newRows);
            DATA = DATA.concat(newRows);
            unitCreatorRows = null;

            alert(`å˜å…ƒã€Œ${unitName}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ˆ${newRows.length}å•ï¼‰ã€‚`);

            renderProblemList(subject, unitName);
        } catch (e) {
            console.error(e);
            alert('å˜å…ƒã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
        }
        });
    }

    draw();
    }

    function getLabelsForSubject(subject) {
      switch (subject) {
          case 'æ¼¢å­—':       return ['æ›¸ã', 'æ„å‘³'];
          case 'ç¾ä»£æ–‡å˜èª': return ['èª­ã¿', 'æ„å‘³'];
          case 'å¤å…¸æ–‡æ³•':   return ['ğŸ‘‰', 'æ„å‘³'];
          case 'å¤å…¸å˜èª':   return ['èª­ã¿', 'æ„å‘³'];
          case 'å¤å…¸å¸¸è­˜':   return ['èª­ã¿', 'æ„å‘³'];
          case 'æ¼¢æ–‡å¥æ³•':   return ['èª­ã¿', 'æ„å‘³'];
          case 'æ¼¢æ–‡èªå½™':   return ['èª­ã¿', 'æ„å‘³'];
          case 'æ¼¢æ–‡å¸¸è­˜':   return ['èª­ã¿', 'æ„å‘³'];
          default:           return ['è§£ç­”1', 'è§£ç­”2'];
      }
    }

    function renderProblemList(subject, unit) {
    const base = String(subject);
    const rows = DATA.filter(x =>
        x.æ•™æ === base && String(x.å˜å…ƒ) === String(unit)
    );

    if (!rows.length) {
        stage.innerHTML = `
        <div class="empty">
            <h2>${escapeHtml(subject)} / ${escapeHtml(unit)}</h2>
            <p>ã“ã®å˜å…ƒã®å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>
            <div style="margin-top:14px;">
            <button class="pill" id="backUnits">å˜å…ƒä¸€è¦§ã«æˆ»ã‚‹</button>
            </div>
        </div>
        `;
        document.getElementById('backUnits').addEventListener('click', () => {
        state.mode = 'idle';
        render();
        });
        return;
    }

    const labels = getLabelsForSubject(subject);

    stage.innerHTML = `
        <div style="width:100%; max-width:720px; margin:auto; display:grid; gap:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <h2 style="margin:0; font-size:20px;">
            ${escapeHtml(subject)} / ${escapeHtml(unit)} ä¸€è¦§
            </h2>
            <div style="display:flex; gap:8px;">
            <button class="pill" id="addProblem">ï¼‹</button>
            <button class="pill" id="backUnits">â†¶</button>
            </div>
        </div>
    
        <div style="display:grid; gap:8px;">
            ${rows.map((row, idx) => {
            const f = row.fields || {};
            const main = escapeHtml(f.main ?? '');
            const f1   = escapeHtml(f.field1 ?? '');
            const f2   = escapeHtml(f.field2 ?? '');

            const label1 = escapeHtml(labels[0] || 'è§£ç­”1');
            const label2 = escapeHtml(labels[1] || 'è§£ç­”2');

            return `
                <div style="border:1px solid var(--stroke); background:rgba(255,255,255,.03); border-radius:12px; padding:10px;">
                <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                    <div>
                    <div style="font-size:12px; color:var(--muted);">No.${idx + 1}</div>
                    <div style="font-size:18px; font-weight:700; margin-top:2px;">${main}</div>
                    ${f1 ? `
                        <div style="font-size:14px; color:var(--muted); margin-top:4px;">
                        <strong>${label1}ï¼š</strong> ${f1}
                        </div>` : ''}
                    ${f2 ? `
                        <div style="font-size:14px; color:var(--muted); margin-top:2px;">
                        <strong>${label2}ï¼š</strong> ${f2}
                        </div>` : ''}
                    </div>
                    <button class="pill" data-edit-id="${row.id}">ç·¨é›†</button>
                </div>
                </div>
            `;
            }).join('')}
        </div>
        </div>
    `;

    document.getElementById('backUnits').addEventListener('click', () => {
        state.mode = 'idle';
        render();
    });

    document.getElementById('addProblem').addEventListener('click', () => {
        renderProblemEditor(subject, unit, null);
    });

    stage.querySelectorAll('button[data-edit-id]').forEach(btn => {
        btn.addEventListener('click', () => {
        const id = Number(btn.getAttribute('data-edit-id'));
        renderProblemEditor(subject, unit, id);
        });
    });
    }

    function renderProblemEditor(subject, unit, id) {
    const baseSubject = String(subject);
    const isNew = (id == null);

    let row;
    if (isNew) {
        row = {
        id: null,
        æ•™æ: baseSubject,
        å˜å…ƒ: unit,
        fields: {
            main: '',
            field1: '',
            field2: '',
        }
        };
    } else {
        row = DATA.find(r => r.id === id);
        if (!row) {
        alert('è©²å½“ã®å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
        renderProblemList(subject, unit);
        return;
        }
    }

    const f = row.fields || {};
    const labels = getLabelsForSubject(subject);

    stage.innerHTML = `
        <div style="width:100%; max-width:720px; margin:auto; display:grid; gap:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <h2 style="margin:0; font-size:20px;">${isNew ? 'æ–°è¦ä½œæˆ' : 'ç·¨é›†'}</h2>
            <button class="pill" id="backList">â†¶</button>
        </div>

        <div style="border:1px solid var(--stroke); background:var(--card);
            border-radius:16px; padding:14px; display:grid; gap:10px;">

            ${isNew ? '' : `
            <div style="font-size:12px; color:var(--muted);">ID: ${id}</div>
            `}

            <div style="font-size:12px; color:var(--muted);">
            ç§‘ç›®ï¼š${escapeHtml(baseSubject)} ï¼ å˜å…ƒï¼š${escapeHtml(unit)}
            </div>

            <label style="display:grid; gap:4px; font-size:13px;">
            <span style="color:var(--muted);">è¡¨ï¼ˆå•é¡Œï¼‰</span>
            <input id="edit-main" type="text"
                value="${escapeAttr(f.main ?? '')}"
                style="padding:8px 10px; border-radius:8px; border:1px solid var(--stroke);
                background:rgba(15,23,42,.9); color:var(--text);">
            </label>

            <label style="display:grid; gap:4px; font-size:13px;">
            <span style="color:var(--muted);">${escapeHtml(labels[0] || 'è£1')}</span>
            <input id="edit-f1" type="text"
                value="${escapeAttr(f.field1 ?? '')}"
                style="padding:8px 10px; border-radius:8px; border:1px solid var(--stroke);
                background:rgba(15,23,42,.9); color:var(--text);">
            </label>

            <label style="display:grid; gap:4px; font-size:13px;">
            <span style="color:var(--muted);">${escapeHtml(labels[1] || 'è£2')}</span>
            <input id="edit-f2" type="text"
                value="${escapeAttr(f.field2 ?? '')}"
                style="padding:8px 10px; border-radius:8px; border:1px solid var(--stroke);
                background:rgba(15,23,42,.9); color:var(--text);">
            </label>

        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="pill" id="saveEdit">${isNew ? 'è¿½åŠ ' : 'ä¿å­˜'}</button>
            ${isNew ? '' : `
            <button class="pill" id="deleteEdit"
            style="border-color:#f97373; color:#fecaca; margin-left:auto;">å‰Šé™¤</button>
            `}
        </div>
        </div>
    `;

    document.getElementById('backList').addEventListener('click', () => {
        renderProblemList(subject, unit);
    });

    document.getElementById('saveEdit').addEventListener('click', async () => {
        const newMain = document.getElementById('edit-main').value.trim();
        const newF1   = document.getElementById('edit-f1').value.trim();
        const newF2   = document.getElementById('edit-f2').value.trim();

        if (!newMain || !newF1 || !newF2) {
        if (!confirm('ç©ºã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ã¾ã¾ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ')) return;
        }

        if (isNew) {
        const nextId = (DATA.length
            ? Math.max(...DATA.map(r => Number(r.id) || 0)) + 1
            : 1);

        const newRow = {
            id: nextId,
            æ•™æ: baseSubject,
            å˜å…ƒ: unit,
            fields: {
            main: newMain,
            field1: newF1,
            field2: newF2,
            }
        };

        try {
            await idbSaveOne(newRow);
            DATA.push(newRow);
            renderProblemList(subject, unit);
        } catch (e) {
            console.error(e);
            alert('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
        }
        } else {
        const updated = {
            ...row,
            fields: {
            main: newMain,
            field1: newF1,
            field2: newF2,
            }
        };

        try {
            await idbSaveOne(updated);
            const idx = DATA.findIndex(r => r.id === id);
            if (idx >= 0) DATA[idx] = updated;

            renderProblemList(subject, unit);
        } catch (e) {
            console.error(e);
            alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
        }
        }
    });

    if (!isNew) {
        document.getElementById('deleteEdit').addEventListener('click', async () => {
        if (!confirm('ã“ã®å•é¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        await idbDeleteOne(id);
        DATA = DATA.filter(r => r.id !== id);
        alert('å‰Šé™¤ã—ã¾ã—ãŸ');
        renderProblemList(subject, unit);
        });
    }
    }

    function getAnswerPairs(row) {
      const labels = getLabelsForSubject(state.subject);
      const a1 = String(row?.fields?.field1 ?? '').trim();
      const a2 = String(row?.fields?.field2 ?? '').trim();
      const pairs = [];
      if (a1) pairs.push([labels[0], a1]);
      if (a2) pairs.push([labels[1], a2]);
      return pairs;
    }

    function render() {
      if (state.view === 'settings') {
        return renderSettings();
      }
      
      const items = getItems();
      if (state.subject === 'home') {
        const srs = lsLoad();

        const overdue = [];
        const todayDue = [];

        Object.entries(srs).forEach(([id, rec]) => {
          if (!rec || rec.step >= 3 || !rec.nextDue) return;
          const [subject, unit] = id.split('|||');
          const delta = daysUntil(rec.nextDue);
          if (delta < 0) overdue.push({ subject, unit, rec, late: Math.abs(delta) });
          else if (delta === 0) todayDue.push({ subject, unit, rec });
        });

        const overdueHtml = overdue.length
          ? `
            <div style="margin-top:8px; text-align:left;">
              <h3 style="margin:0 0 8px; font-size:20px; color:#ffffff; font-weight:800;">æœªå®Œäº†</h3>
              <div style="display:grid; gap:8px;">
                ${overdue.map(x =>
                  unitCardHTML(
                    x.subject,
                    x.unit,
                    unitCount(x.subject, x.unit),
                    x.rec,
                    true,
                    false
                  )
                ).join('')}
              </div>
            </div>`
          : '';

        const todayHtml = todayDue.length
          ? `
            <div style="margin-top:16px; text-align:left;">
              <h3 style="margin:0 0 8px; font-size:20px; color:#ffffff; font-weight:800;">ä»Šæ—¥ã®å¾©ç¿’</h3>
              <div style="display:grid; gap:8px;">
                ${todayDue.map(x =>
                  unitCardHTML(
                    x.subject,
                    x.unit,
                    unitCount(x.subject, x.unit),
                    x.rec,
                    false,
                    false
                  )
                ).join('')}
              </div>
            </div>`
          : `<p style="margin-top:12px; font-size:13px; color:var(--muted)">æœ¬æ—¥äºˆå®šã®å¾©ç¿’ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;

        stage.innerHTML = `
          <div class="empty" id="empty" style="width:100%; max-width:720px; margin:auto; text-align:left;">
            ${overdueHtml}
            ${todayHtml}
          </div>`;

        stage.querySelectorAll('[data-due-start]').forEach(btn => {
          btn.addEventListener('click', () => {
            const [subject, unit] = btn.getAttribute('data-due-start').split('|||');
            state.subject = subject;
            state.unit = unit === 'ALL' ? null : unit;
            startQuiz(state.unit);
          });
        });

        return;
      }

      if (state.mode === 'idle') {
        return renderUnitList();
      }

      const qa = currentQA();
      if (!qa) return renderUnitList();
      const { q } = qa;
      const pairs = getAnswerPairs(qa.row);
      const total = items.length;
      const now = state.index + 1;

      stage.innerHTML = `
        <div style="width:100%; max-width:720px;">
          <div style="margin-bottom:6px; font-size:14px; font-weight:700; color:var(--muted); text-align:center;">
            ${escapeHtml(state.unit ?? state.subject)}
          </div>
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; font-size:13px; color:var(--muted)">
            <div>ã€€${now} / ${total}</div>
            <div>æ­£è§£ï¼š${state.correct}ã€€ä¸æ­£è§£ï¼š${state.wrong.length}</div>
          </div>

          <div style="border:1px solid var(--stroke); background:var(--card); border-radius:20px; padding:18px; box-shadow: var(--shadow);">
            <div style="font-size:14px; color:var(--muted); margin-bottom:6px;">å•é¡Œ</div>
            <div style="font-size:28px; font-weight:800; line-height:1.25;">${escapeHtml(q)}</div>
          </div>

          <div id="answerBox" style="margin-top:14px;">
            <div style="border:1px solid var(--stroke); background:rgba(255,255,255,.03); border-radius:16px; padding:16px;">
              <div style="font-size:14px; color:var(--muted); margin-bottom:6px;">ç­”ãˆ</div>
              <div id="answerContent" style="display:grid; gap:8px; font-size:20px; font-weight:700;">
                ${pairs.map(([label, val]) => `
                  <div style="display:grid; grid-template-columns:max-content 1fr; gap:10px; align-items:start;">
                    <div style="color:var(--muted); white-space:nowrap;">${escapeHtml(label)}ï¼š</div>
                    <div>${state.showAnswer ? escapeHtml(val) : ''}</div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>

          <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="pill" id="reveal">${state.showAnswer ? 'ç­”ãˆã‚’éš ã™' : 'ç­”ãˆã‚’è¡¨ç¤º'}</button>
            ${state.showAnswer ? `
              <button class="pill" id="ok">æ­£è§£</button>
              <button class="pill" id="ng">ä¸æ­£è§£</button>
            ` : ''}
          </div>
        </div>`;
      document.getElementById('reveal')
        .addEventListener('click', () => { state.showAnswer = !state.showAnswer; render(); });
      
      document.getElementById('ok')?.addEventListener('click', () => mark(true));
      document.getElementById('ng')?.addEventListener('click', () => mark(false));
    }
    function makeExportFilename() {
      const d = new Date();
      const pad = (n) => String(n).padStart(2, '0');

      const y = d.getFullYear();
      const m = pad(d.getMonth() + 1);
      const day = pad(d.getDate());
      const h = pad(d.getHours());
      const min = pad(d.getMinutes());
      const s = pad(d.getSeconds());

      return `genkokan-export-${y}-${m}-${day}_${h}-${min}-${s}.json`;
    }

    function renderSettings() {
      const srsCount = Object.keys(lsLoad() || {}).length;
    
      stage.innerHTML = `
        <div style="width:100%; max-width:720px; margin:auto; display:grid; gap:14px;">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <h2 style="margin:0; font-size:20px;">è¨­å®š</h2>
            <button class="pill" id="backMain">â†¶</button>
          </div>
    
          <div style="border:1px solid var(--stroke); background:var(--card); border-radius:16px; padding:14px;">
            <div style="font-size:14px; color:var(--muted); margin-bottom:6px;">DBç®¡ç†</div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <label class="pill" for="jsonFileLive" style="cursor:pointer;">JSONå–ã‚Šè¾¼ã¿</label>
              <input id="jsonFileLive" type="file" accept="application/json" multiple style="display:none">
              <button class="pill" id="exportJsonLive">JSONæ›¸ãå‡ºã—</button>
              <button class="pill" id="clearDbLive">DBæ¶ˆå»</button>
            </div>
          </div>
    
          <div style="border:1px solid var(--stroke); background:var(--card); border-radius:16px; padding:14px;">
            <div style="font-size:14px; color:var(--muted); margin-bottom:6px;">å­¦ç¿’å±¥æ­´</div>
            <div style="font-size:13px; color:var(--muted); margin-bottom:10px;">
              <strong>${srsCount}</strong>ä»¶ã®è¨˜éŒ²ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="pill" id="resetSrsLive">å­¦ç¿’å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
          </div>

          <div style="border:1px solid var(--stroke); background:var(--card); border-radius:16px; padding:14px;">
            <div style="font-size:14px; color:var(--muted); margin-bottom:6px;">æ›´æ–°å±¥æ­´</div>
            ${renderReleaseNotes()}
          </div>
        </div>
      `;
    
      document.getElementById('backMain')?.addEventListener('click', () => {
        state.view = 'main';
        render();
      });
    
      document.getElementById('jsonFileLive')?.addEventListener('change', async (ev) => {
        const files = ev.target.files;
        if (!files || !files.length) return;
      
        try {
          const result = await importJsonFiles(files);
          if (result) {
            alert(`å–ã‚Šè¾¼ã¿å®Œäº†ï¼š${result.imported}ä»¶ï¼ˆ${result.files}ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰`);
            render();
          }
        } catch (e) {
          alert('å–ã‚Šè¾¼ã¿å¤±æ•—ï¼š' + e.message);
        } finally {
          ev.target.value = '';
        }
      });

      document.getElementById('exportJsonLive')?.addEventListener('click', async () => {
        const all = await idbGetAll();
        const blob = new Blob([JSON.stringify(all, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = makeExportFilename();
        a.click();
        URL.revokeObjectURL(url);
      });
    
      document.getElementById('clearDbLive')?.addEventListener('click', async () => {
        if (!confirm('ã‚«ãƒ¼ãƒ‰DBã‚’å…¨æ¶ˆå»ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
        await idbClear();
        DATA = [];
        alert('DBã‚’ç©ºã«ã—ã¾ã—ãŸã€‚');
        render();
      });
    
      document.getElementById('resetSrsLive')?.addEventListener('click', () => {
        if (!confirm('å­¦ç¿’å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
        localStorage.removeItem(SKEY);
        alert('å­¦ç¿’å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚');
        render();
      });
    }

    function renderReleaseNotes() {
      if (!Array.isArray(RELEASE_NOTES) || RELEASE_NOTES.length === 0) {
        return `<p style="font-size:13px; color:var(--muted);">æ›´æ–°å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>`;
      }
    
      return `
        <div style="display:grid; gap:20px;">
          ${RELEASE_NOTES.map(r => `
            <div>
              <div style="font-size:16px; font-weight:700;">
                ${escapeHtml(r.version)}
                <span style="font-size:12px; color:var(--muted); margin-left:6px;">
                  ${escapeHtml(r.date)}
                </span>
              </div>
              <ul style="margin:8px 0 0 18px; padding:0; font-size:13px;">
                ${r.items.map(it => `<li>${escapeHtml(it)}</li>`).join('')}
              </ul>
            </div>
          `).join('')}
        </div>
      `;
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }
    function escapeAttr(s) {
      return String(s).replaceAll('"', '&quot;');
    }

    render();

    function unitCount(subject, unit) {
      return DATA.filter(x => x.æ•™æ === subject && String(x.å˜å…ƒ) === String(unit)).length;
    }

    function unitCardHTML(subject, unit, count, rec, emphasize = false, withList = false) {
      const id = unitId(subject, unit);
      const dueTag = rec ? formatDueTag(rec.nextDue) : '';
      const progress = rec ? Math.min((rec.step + 1) / 4, 1) : 0;
      const pct = `${(Math.max(0, Math.min(1, progress)) * 100).toFixed(1)}%`;
    
      const startColor = '#A855F7';
      const midColor   = '#6366F1';
      const endColor   = '#0EA5E9';
    
      const dueLine = rec
        ? `<div style="font-size:12px; color:var(--muted);">æ¬¡ã®å¾©ç¿’ï¼š${rec.nextDue || 'â€”'}${dueTag ? `ï¼ˆ${dueTag}ï¼‰` : ''}</div>`
        : `<div style="font-size:12px; color:var(--muted);">æ¬¡ã®å¾©ç¿’ï¼šâ€”</div>`;
    
      const rightButtons = withList
        ? `
          <div style="display:flex; gap:8px;">
            <button
              class="pill"
              style="padding:0 14px;"
              data-unit-list="${escapeAttr(unit)}">
              ğŸ“‹
            </button>
            <button
              class="pill"
              style="padding:0 14px;"
              data-judge="start"
              data-due-start="${escapeAttr(id)}"
              data-unit-card="${escapeAttr(unit)}">
              ğŸ–Šï¸
            </button>
          </div>`
        : `
          <button
            class="pill"
            data-judge="start"
            data-due-start="${escapeAttr(id)}"
            data-unit-card="${escapeAttr(unit)}">
            ğŸ–Šï¸
          </button>`;
    
      return `
        <div class="unit-card"
            data-subject="${escapeAttr(subject)}"
            data-unit-card="${escapeAttr(unit)}"
            style="
              --pct:${pct};
              --grad-start:${startColor};
              --grad-mid:${midColor};
              --grad-end:${endColor};
              border:1px solid var(--stroke);
              ${emphasize ? 'outline:2px solid rgba(96,165,250,.35);' : ''}">
          <div class="uc-content"
               style="padding:14px; display:flex; justify-content:space-between; align-items:center; gap:12px;">
            <div>
              <div style="font-size:12px; color:var(--muted);">${escapeHtml(subject)}</div>
              <div style="font-size:18px; font-weight:800; color:var(--text);">${escapeHtml(unit)}</div>
              <div style="font-size:12px; color:var(--muted); margin-top:4px;">å•é¡Œæ•°ï¼š${count}</div>
              ${dueLine}
            </div>
            ${rightButtons}
          </div>
        </div>`;
    }

  </script>

  <div id="dev-fab" title="é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ï¼šä»Šæ—¥ã«è¿½åŠ ">DEV</div>
  <div id="dev-panel" role="dialog" aria-label="é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ãƒ‘ãƒãƒ«" style="display:none;">
    <h4>ä»Šæ—¥ã®å¾©ç¿’ã«è¿½åŠ ï¼ˆæ‰‹å‹•ï¼‰</h4>
    <div class="row">
      <div>ç§‘ç›® / å˜å…ƒ</div>
      <div class="unit" id="dev-target">ï¼ˆæœªé¸æŠï¼‰</div>
    </div>
    <div class="btns">
      <button class="pill mini" data-step="0">+1æ—¥ï¼ˆä»Šæ—¥ã«ï¼‰</button>
      <button class="pill mini" data-step="1">+7æ—¥ï¼ˆä»Šæ—¥ã«ï¼‰</button>
      <button class="pill mini" data-step="2">+30æ—¥ï¼ˆä»Šæ—¥ã«ï¼‰</button>
      <button class="pill mini" id="dev-close">é–‰ã˜ã‚‹</button>
    </div>
    <div class="warn" id="dev-warn" style="display:none;">â€» å˜å…ƒãŒæœªé¸æŠï¼ˆç§‘ç›®å…¨ä½“å‡ºé¡Œä¸­ï¼‰ã¯è¿½åŠ ã§ãã¾ã›ã‚“ã€‚</div>
  </div>

  <script>

  const DEV_MODE = false;

  const RELEASE_NOTES = [
  {
    version: 'ver0.1.0',
    date: '2025-11-29',
    items: [
    'Î²ç‰ˆãƒªãƒªãƒ¼ã‚¹'
    ]
  }
];

  function _srsHelpersReady() {
    return typeof lsLoad === 'function'
      && typeof lsSave === 'function'
      && typeof unitId === 'function'
      && Array.isArray(SRS_STEPS)
      && typeof emptyRec === 'function'
      && typeof todayStr === 'function'
      && typeof addDaysStr === 'function';
  }

  function addSRS_dueToday(subject, unit, stepIndex = 0) {
    if (!_srsHelpersReady()) { console.warn('SRSãƒ˜ãƒ«ãƒ‘ãƒ¼æœªå®šç¾©'); return; }
    if (!subject || !unit) { console.warn('subject/unit å¿…é ˆ'); return; }
    if (stepIndex < 0 || stepIndex >= SRS_STEPS.length) {
      console.warn('stepIndex ã¯ 0..' + (SRS_STEPS.length-1)); return;
    }
    const id = unitId(subject, unit);
    const srs = lsLoad();
    const rec = srs[id] || emptyRec();
    const today = todayStr();
    const offset = SRS_STEPS[stepIndex];
    const base = addDaysStr(today, -offset);

    rec.baseDate = base;
    rec.step = stepIndex;
    rec.nextDue = today;

    srs[id] = rec;
    lsSave(srs);
    console.log('SRSè¿½åŠ /æ›´æ–°:', id, rec);
    if (state.subject === 'home') render();
  }

  function initDevPanel() {
    const fab = document.getElementById('dev-fab');
    const panel = document.getElementById('dev-panel');
    const target = document.getElementById('dev-target');
    const warn = document.getElementById('dev-warn');
    const closeBtn = document.getElementById('dev-close');

    if (!DEV_MODE) { fab.style.display = 'none'; panel.style.display = 'none'; return; }
    if (!fab || !panel) return;

    function updateTargetText() {
      const subj = state?.subject ?? 'ï¼ˆæœªé¸æŠï¼‰';
      const unit = (state?.unit != null) ? state.unit : 'ï¼ˆç§‘ç›®å…¨ä½“ï¼‰';
      target.textContent = `${subj} / ${unit}`;
      warn.style.display = (state?.unit == null) ? '' : 'none';
    }

    fab.addEventListener('click', () => {
      updateTargetText();
      panel.style.display = (panel.style.display === 'none' || !panel.style.display) ? 'block' : 'none';
    });

    closeBtn.addEventListener('click', () => { panel.style.display = 'none'; });

    panel.querySelectorAll('[data-step]').forEach(btn => {
      btn.addEventListener('click', () => {
        if (state?.unit == null) { updateTargetText(); return; }
        const step = parseInt(btn.getAttribute('data-step') || '0', 10);
        addSRS_dueToday(state.subject, state.unit, step);
        panel.style.display = 'none';
      });
    });
  }

  document.addEventListener('DOMContentLoaded', initDevPanel);
  </script>
  
  <script>
    const settingsBtn = document.getElementById('settings-btn');
    const settingsPanel = document.getElementById('settings-panel');
    
    settingsBtn.addEventListener('click', () => {
      if (state.view === 'settings') {
        state.view = 'main';
        if (settingsPanel) settingsPanel.style.display = 'none';
      } else {
        state.view = 'settings';
        if (settingsPanel) settingsPanel.style.display = 'none';
      }
      render();
    });
  </script>

  <script>
  const DB_NAME = '${APP_NS}_cards';
  const DB_VERSION = 1;
  const STORE = 'cards';

  function openDb() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, DB_VERSION);
      req.onupgradeneeded = (e) => {
        const db = req.result;
        if (!db.objectStoreNames.contains(STORE)) {
          const os = db.createObjectStore(STORE, { keyPath: 'id' });
          os.createIndex('by_subject', 'æ•™æ', { unique: false });
          os.createIndex('by_unit', 'å˜å…ƒ', { unique: false });
          os.createIndex('by_subject_unit', ['æ•™æ', 'å˜å…ƒ'], { unique: false });
        }
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }

  function withStore(db, mode, fn) {
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE, mode);
      const st = tx.objectStore(STORE);
      const r = fn(st);
      tx.oncomplete = () => resolve(r);
      tx.onerror = () => reject(tx.error);
    });
  }

  async function idbGetAll() {
    const db = await openDb();
    return new Promise((resolve, reject) => {
      withStore(db, 'readonly', (st) => {
        const req = st.getAll();
        req.onsuccess = () => resolve(req.result || []);
        req.onerror = () => reject(req.error);
      });
    });
  }

  async function idbBulkPut(rows) {
    const db = await openDb();
    await withStore(db, 'readwrite', (st) => {
      rows.forEach(row => st.put(row));
    });
  }

  async function idbClear() {
    const db = await openDb();
    await withStore(db, 'readwrite', (st) => st.clear());
  }

async function importJsonFiles(fileList) {
  const files = Array.from(fileList || []);
  if (!files.length) return null;

  const existing = await idbGetAll();
  const maxId = existing.length
    ? Math.max(...existing.map(r => Number(r.id) || 0))
    : 0;

  const makeKey = (row) => {
    const subj = String(row?.æ•™æ ?? row?.subject ?? '').trim();
    const unit = String(row?.å˜å…ƒ ?? row?.unit ?? '').trim();
    const main = String(row?.fields?.main ?? '').trim();
    if (!subj || !unit || !main) return '';
    return `${subj}|||${unit}|||${main}`;
  };

  const seen = new Set(
    existing
      .map(makeKey)
      .filter(k => k)
  );

  const merged = [];

  for (const file of files) {
    const text = await file.text();
    let arr;
    try {
      arr = JSON.parse(text);
    } catch (e) {
      throw new Error(`${file.name}: JSONã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ`);
    }
    if (!Array.isArray(arr)) {
      throw new Error(`${file.name}: JSONã¯é…åˆ—ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™`);
    }

    for (const rawRow of arr) {
      const subj = String(rawRow?.æ•™æ ?? rawRow?.subject ?? '').trim();
      const unit = String(rawRow?.å˜å…ƒ ?? rawRow?.unit ?? '').trim();
      const fieldsSrc = rawRow?.fields && typeof rawRow.fields === 'object'
        ? rawRow.fields
        : {};

      const main = String(fieldsSrc.main ?? '').trim();
      const f1   = String(fieldsSrc.field1 ?? '').trim();
      const f2   = String(fieldsSrc.field2 ?? '').trim();

      if (!subj || !unit || !main) continue;

      const tmpKey = `${subj}|||${unit}|||${main}`;
      if (seen.has(tmpKey)) continue;
      seen.add(tmpKey);

      const row = {
        ...rawRow,
        æ•™æ: subj,
        å˜å…ƒ: unit,
        fields: {
          ...fieldsSrc,
          main,
          field1: f1,
          ...(f2 ? { field2: f2 } : ('field2' in fieldsSrc ? { field2: f2 } : {})),
        },
      };

      merged.push(row);
    }
  }

  if (!merged.length) {
    return {
      files: files.length,
      imported: 0,
      total: existing.length,
    };
  }

  const normalized = merged.map((row, idx) => ({
    ...row,
    id: maxId + idx + 1,
  }));

  await idbBulkPut(normalized);

  const all = await idbGetAll();
  DATA = all;

  return {
    files: files.length,
    imported: normalized.length,
    total: all.length,
  };
}

  async function idbSaveOne(row) {
    const db = await openDb();
    await withStore(db, 'readwrite', (st) => {
      st.put(row);
    });
  }
  
  async function idbDeleteOne(id) {
    const db = await openDb();
    await withStore(db, 'readwrite', (st) => {
      st.delete(id);
    });
  }
  
  async function bootDataFromIDB() {
    let rows = await idbGetAll();
    DATA = rows;
    console.log('DATA loaded from IDB:', rows.length);
  }

  document.getElementById('jsonFile')?.addEventListener('change', async (ev) => {
    const files = ev.target.files;
    if (!files || !files.length) return;
  
    try {
      const result = await importJsonFiles(files);
      if (result) {
        alert(`å–ã‚Šè¾¼ã¿å®Œäº†ï¼š${result.imported}ä»¶ï¼ˆ${result.files}ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰`);
        render();
      }
    } catch (e) {
      alert('å–ã‚Šè¾¼ã¿å¤±æ•—ï¼š' + e.message);
    } finally {
      ev.target.value = '';
    }
  });

  document.getElementById('exportJson')?.addEventListener('click', async () => {
    const all = await idbGetAll();
    const blob = new Blob([JSON.stringify(all, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = makeExportFilename();
    a.click();
    URL.revokeObjectURL(url);
  });

  document.getElementById('clearDb')?.addEventListener('click', async () => {
    if (!confirm('ã‚«ãƒ¼ãƒ‰DBã‚’å…¨æ¶ˆå»ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
    await idbClear();
    window.DATA = [];
    alert('DBã‚’ç©ºã«ã—ã¾ã—ãŸã€‚');
  });

  (async () => {
    try {
      await bootDataFromIDB();
      render();
    } catch(e) { console.error('[boot] failed:', e); }
  })();
  </script>

</body>
</html>


